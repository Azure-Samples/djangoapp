define(["marketplace.utils"],function(marketplaceUtils){var MARKETPLACE_LIBRARY_SCHEMA={USERS:{UID:"6"},ASSETS:{DBID:"15"},VERSIONS:{UID:"36",DBID:"6",DATE_CREATED:"1"},APPLICATIONS:{DBID:"14",MARKETPLACE_ID:"3"},CATEOGRIES:{NAME:"6"},ACTIVITY_LOG:{MARKETPLACE_ID:"21"},PUBLISHED:{DBID:"46",UID:"30",QUERY_PUBLISHED_STATS:"5",QUERY_ALL_PUBLISHED:"8",MARKETPLACE_ID:"9"}};var api={error:function(resp){marketplaceUtils.track("Marketplace_API_Error");if(resp&&resp.errorText){QB.Dialog.error({contents:resp.errorText})}else{if(resp&&$(resp).find("errdetail").length>0){QB.Dialog.error({contents:$(resp).find("errdetail").text()})}else{QB.Dialog.error({contents:"Your request wasn't completed. Please refresh the page and try again."})}}},STATE:{DRAFT:"Draft",PENDING:"PENDING-APP",PUBLISHED:"PUBLISHED",REJECTED:"REJECTED"},IsUserOnTrial:function(){return marketplace_consts.QBUser.QBTrialer},IsUserOnEssentialPlan:function(){return marketplace_consts.QBUser.QBOnEssentialPlan},getWidgetStats:function(){var deferred=$.Deferred();$.ajax({async:true,cache:false,url:marketplace_consts.marketplaceLibraryDBID+"/(_DBID_PUBLISHED)?act=JBI_Marketplace_GetStats&qid="+MARKETPLACE_LIBRARY_SCHEMA.PUBLISHED.QUERY_PUBLISHED_STATS,error:function(e){},data:{PageToken:marketplace_consts.marketplaceToken}}).pipe(function(resp){var stats={};var totalDownloads=0;var appsTotal=0;if(resp&&resp.result){appsTotal=resp.result.number_of_published_app_versions;totalDownloads=resp.result.installs__tot_}if(resp&&resp.errCode!=0){marketplaceUtils.track("Marketplace_Widget_Error",resp.errorText)}stats.apps_available=appsTotal;stats.apps_downloaded=totalDownloads;deferred.resolve(stats)});return deferred.promise()},getCategories:function(){var deferred=$.Deferred();$.ajax({async:true,datatype:"xml",cache:false,url:marketplace_consts.marketplaceLibraryDBID+"/(_DBID_CATEGORIES)?act=API_DOQUERY&slist="+MARKETPLACE_LIBRARY_SCHEMA.CATEOGRIES.NAME}).pipe(function(resp){if(resp&&$("qdbapi errcode",resp).text()==0){var categories=[];$("record",resp).each(function(index,app){var aCategory=serializers.ResponseToCategory(app);aCategory.status="Published";categories.push(aCategory)});deferred.resolve(categories)}else{deferred.reject()}});return deferred.promise()},getPublishedApps:function(){var deferred=$.Deferred();$.ajax({async:true,datatype:"xml",cache:false,url:marketplace_consts.marketplaceLibraryDBID+"/(_DBID_PUBLISHED)?act=JBI_Marketplace_GetPublished&qid="+MARKETPLACE_LIBRARY_SCHEMA.PUBLISHED.QUERY_ALL_PUBLISHED,data:{PageToken:marketplace_consts.marketplaceToken}}).pipe(function(resp){if(resp&&resp.errcode=="0"){deferred.resolve(resp)}else{deferred.reject()}});return deferred.promise()},getMyApps:function(qbUID){if(qbUID==null||typeof qbUID==undefined){return}var deferred=$.Deferred();$.ajax({async:true,datatype:"xml",cache:false,url:marketplace_consts.marketplaceLibraryDBID+"/(_DBID_Versions)?a=API_DoQuery&query={"+MARKETPLACE_LIBRARY_SCHEMA.VERSIONS.UID+".EX."+qbUID+"}&options=sortorder-A&includerids=true&slist="+MARKETPLACE_LIBRARY_SCHEMA.VERSIONS.DATE_CREATED}).pipe(function(resp){if(resp&&$("qdbapi errcode",resp).text()==0){var apps=[];var appSet=$("record",resp);appSet.each(function(index,app){var anApp=serializers.VersionsToApp(app);anApp.isMyApp=true;anApp.date_for_sort=new Date(anApp.date_created);anApp.appNameTipsy=HTMLEncode(HTMLEncode(anApp.app_name_full));apps.push(anApp)});deferred.resolve(apps)}else{deferred.reject()}});return deferred.promise()},getAppInfo:function(qbDBID){if(qbDBID==null||typeof qbDBID==undefined){return}var deferred=$.Deferred();var app={};$.ajax({async:true,datatype:"json",cache:false,url:marketplace_consts.marketplaceLibraryDBID+"/(_DBID_Versions)?a=API_DoQuery&includeRids=true&query={"+MARKETPLACE_LIBRARY_SCHEMA.VERSIONS.DBID+".EX."+qbDBID+"}",success:function(data,textStatus,XMLHttpRequest){if($("qdbapi errcode",data).text()==0){$("record",data).each(function(index,appResponse){app=serializers.VersionsToApp(appResponse);app.rid=($(appResponse).attr("rid"))})}deferred.resolve(app)},error:function(){deferred.resolve(app)}});return deferred.promise()},getPublishedAppInfo:function(marketplaceID){if(marketplaceID==null||typeof marketplaceID==undefined){return}var deferred=$.Deferred();var app={};$.ajax({async:true,datatype:"json",cache:false,url:marketplace_consts.marketplaceLibraryDBID+"/(_DBID_PUBLISHED)?a=API_DoQuery&includeRids=true&query={"+MARKETPLACE_LIBRARY_SCHEMA.PUBLISHED.MARKETPLACE_ID+".EX."+marketplaceID+"}",success:function(data,textStatus,XMLHttpRequest){if($("qdbapi errcode",data).text()==0){$("record",data).each(function(index,appResponse){app=serializers.PublishedToApp(appResponse)})}deferred.resolve(app)},error:function(){deferred.resolve(app)}});return deferred.promise()},copyApp:function(appObject){if(!_.isUndefined(appObject.status)){return api.editApp(appObject)}else{return api.createDraftApp(appObject.dbid,appObject.app_name,appObject.keepData)}},createDraftApp:function(dbid,dbname,keepData){var deferred=$.Deferred();if(dbid==null||typeof dbid==undefined){return}$.ajax({async:true,datatype:"json",cache:false,url:dbid+"?act=JBI_Marketplace_Clone&state=draft",data:{newdbname:dbname,PageToken:marketplace_consts.marketplaceToken,keepData:keepData}}).pipe(function(resp){if(!resp||!resp.newdbid){deferred.reject(resp)}else{deferred.resolve(resp)}});return deferred.promise()},submitApp:function(_app){if($.isEmptyObject(_app)){return}var deferred=$.Deferred();if(_app.dbid==null||typeof _app.dbid==undefined){return}api.getUserInfo(marketplace_consts.QBUser.QBUID).then(function(user){var app={};app.dbid=_app.dbid;app.dbname=_app.dbname;app.app_description=_app.app_description;app.status=api.STATE.DRAFT;app.related_submitter=marketplace_consts.QBUser.QBUID;if($.isEmptyObject(user)){user.uid=marketplace_consts.QBUser.QBUID;user.draft="1";user.nickName=marketplace_consts.QBUser.QBFirstName+" "+marketplace_consts.QBUser.QBLastName;api.addUserInfo(user).then(function(){utils.addToApplications(app).then(function(marketplace_APPID){app.marketplace_APPID=marketplace_APPID;utils.addToVersions(app).then(function(){deferred.resolve()})})})}else{utils.addToApplications(app).then(function(marketplace_APPID){app.marketplace_APPID=marketplace_APPID;utils.addToVersions(app).then(function(){deferred.resolve()})})}});return deferred.promise()},editAppInfo:function(app){var deferred=$.Deferred();var request=serializers.AppToRequest(app);request.PageToken=marketplace_consts.marketplaceToken;$.ajax({async:true,datatype:"json",cache:false,url:marketplace_consts.marketplaceLibraryDBID+"/(_DBID_Versions)?act=QBI_Marketplace_Edit",data:request,success:function(){deferred.resolve()}});$.ajax({async:true,datatype:"json",cache:false,url:app.dbid+"?act=JBI_Marketplace_SaveAppMetaInfo",data:{app_name:app.app_name,PageToken:marketplace_consts.marketplaceToken,app_description:app.app_description},success:function(){}});return deferred.promise()},transferAppToCurator:function(appName,appDescription){var deferred=$.Deferred();$.ajax({async:true,datatype:"json",cache:false,url:marketplace_consts.QBDBID+"?a=JBI_Marketplace_Submit",data:{appName:appName,appDescription:appDescription,PageToken:marketplace_consts.marketplaceToken},success:function(){deferred.resolve()}});return deferred.promise()},deleteApp:function(status,qbDBID,isEdit){var deferred=$.Deferred();var deleteQB;status=status.toLowerCase();if(status.indexOf(api.STATE.PENDING.toLowerCase())!==-1||api.STATE.PENDING.toLowerCase().indexOf(status)!==-1||status.indexOf(api.STATE.PUBLISHED.toLowerCase())!==-1){deleteQB=api.deleteSubmittedAppfromQB}else{if(status.indexOf(api.STATE.DRAFT.toLowerCase())!==-1||status.indexOf(api.STATE.REJECTED.toLowerCase())!==-1){deleteQB=api.deleteDraftfromQB}else{return}}var deleteLibrary;if(status.indexOf(api.STATE.PUBLISHED.toLowerCase())!==-1){deleteLibrary=api.deletePublishedApp}else{if(status.indexOf(api.STATE.PENDING.toLowerCase())!==-1||api.STATE.PENDING.toLowerCase().indexOf(status)!==-1||(status.indexOf(api.STATE.DRAFT.toLowerCase())!==-1)||(status.indexOf(api.STATE.REJECTED.toLowerCase())!==-1)){deleteLibrary=api.deleteNonPublishedApp}else{return}}api.deleteAssets(qbDBID).then(function(){deleteLibrary(qbDBID,isEdit).then(function(){deleteQB(qbDBID).then(function(){deferred.resolve()})})});return deferred.promise()},deleteDraftfromQB:function(qbDBID){var deferred=$.Deferred();if(qbDBID==null||typeof qbDBID==undefined){return}$.ajax({async:true,datatype:"json",cache:false,url:qbDBID+"?act=JBI_Marketplace_DeleteDraft",data:{PageToken:marketplace_consts.marketplaceToken}}).pipe(function(resp){if(!resp||resp.errcode!="0"){deferred.reject()}else{deferred.resolve()}});return deferred.promise()},deleteSubmittedAppfromQB:function(qbDBID){var deferred=$.Deferred();if(qbDBID==null||typeof qbDBID==undefined){return}if(marketplace_consts.marketplaceToken==null||typeof marketplace_consts.marketplaceToken==undefined){return}var request={};request.PageToken=marketplace_consts.marketplaceToken;$.ajax({async:true,datatype:"json",cache:false,url:qbDBID+"?act=JBI_Marketplace_DeleteApp",data:request}).pipe(function(resp){if(resp&&resp.errcode=="0"){deferred.resolve()}else{deferred.reject()}});return deferred.promise()},deleteNonPublishedApp:function(qbDBID,isEdit){if(qbDBID==null||typeof qbDBID==undefined){return}var deferred=$.Deferred();api.getAppInfo(qbDBID).then(function(app){$.ajax({async:true,datatype:"json",cache:false,url:marketplace_consts.marketplaceLibraryDBID+"/(_DBID_Versions)?act=QBI_Marketplace_Delete",data:{rid:app.rid,dbid:qbDBID,marketplace_id:app.marketplace_id,status:app.status,PageToken:marketplace_consts.marketplaceToken},success:function(resp){if(!isEdit){if($(resp).find("errcode").text()==0){$.ajax({async:true,datatype:"json",cache:false,url:marketplace_consts.marketplaceLibraryDBID+"/(_DBID_Applications)?a=API_DoQuery&includeRids=true&query={"+MARKETPLACE_LIBRARY_SCHEMA.APPLICATIONS.MARKETPLACE_ID+".EX."+app.marketplace_id+"}",success:function(data,textStatus,XMLHttpRequest){if($("qdbapi errcode",data).text()==0){$("record",data).each(function(index,userXML){var appRId=($(userXML).attr("rid"));$.ajax({async:true,datatype:"json",cache:false,url:marketplace_consts.marketplaceLibraryDBID+"/(_DBID_Applications)?act=QBI_Marketplace_Delete",data:{rid:appRId,PageToken:marketplace_consts.marketplaceToken},success:function(resp){if($(resp).find("errcode").text()==0){deferred.resolve()}}})})}}})}}else{deferred.resolve()}}})});return deferred.promise()},deletePublishedApp:function(qbDBID){if(qbDBID==null||typeof qbDBID==undefined){return}var deferred=$.Deferred();$.ajax({async:true,datatype:"json",cache:false,url:marketplace_consts.marketplaceLibraryDBID+"/(_DBID_PUBLISHED)?a=API_DoQuery&includeRids=true&query={"+MARKETPLACE_LIBRARY_SCHEMA.PUBLISHED.DBID+".EX."+qbDBID+"}",success:function(data,textStatus,XMLHttpRequest){if($("qdbapi errcode",data).text()==0){$("record",data).each(function(index,appXML){var appRId=($(appXML).attr("rid"));$.ajax({async:true,datatype:"json",cache:false,url:marketplace_consts.marketplaceLibraryDBID+"/(_DBID_PUBLISHED)?act=QBI_Marketplace_Edit&_fnm_status=Obsolete",data:{rid:appRId,marketplace_id:$(appXML).find("marketplace_id").text(),dbid:$(appXML).find("dbid").text(),status:"Published",PageToken:marketplace_consts.marketplaceToken},success:function(resp){if($(resp).find("errcode").text()==0){api.deleteNonPublishedApp(qbDBID).then(function(){deferred.resolve()})}}})})}}});return deferred.promise()},deleteAssets:function(qbDBID){if(qbDBID==null||typeof qbDBID==undefined){return}var deferred=$.Deferred();$.ajax({async:true,datatype:"json",cache:false,url:marketplace_consts.marketplaceLibraryDBID+"/(_DBID_ASSETS)?a=API_DoQuery&includeRids=true&query={"+MARKETPLACE_LIBRARY_SCHEMA.ASSETS.DBID+".EX."+qbDBID+"}",success:function(data,textStatus,XMLHttpRequest){if($("qdbapi errcode",data).text()==0){if($("record",data).length==0){deferred.resolve()}$("record",data).each(function(index,appXML){var appRId=($(appXML).attr("rid"));$.ajax({async:true,datatype:"json",cache:false,url:marketplace_consts.marketplaceLibraryDBID+"/(_DBID_ASSETS)?act=QBI_Marketplace_Delete",data:{rid:appRId,PageToken:marketplace_consts.marketplaceToken},success:function(resp){if($(resp).find("errcode").text()==0){deferred.resolve()}}})})}}});return deferred.promise()},getUserInfo:function(userid){if(userid==null||typeof userid==undefined){return}var deferred=$.Deferred();var user={};$.ajax({async:true,datatype:"json",cache:false,url:marketplace_consts.marketplaceLibraryDBID+"/(_DBID_USERS)?a=API_DoQuery&query={"+MARKETPLACE_LIBRARY_SCHEMA.USERS.UID+".EX."+userid+"}",success:function(data,textStatus,XMLHttpRequest){if($("qdbapi errcode",data).text()==0){$("record",data).each(function(index,userXML){user=serializers.ResponseToUser(userXML);return false})}deferred.resolve(user)},error:function(){deferred.resolve(user)}});return deferred.promise()},addUserInfo:function(user){var deferred=$.Deferred();var request=serializers.UserToRequest(user);request.PageToken=marketplace_consts.marketplaceToken;$.ajax({async:true,datatype:"json",cache:false,url:marketplace_consts.marketplaceLibraryDBID+"/(_DBID_Users)?act=QBI_Marketplace_Add",data:request,success:function(){deferred.resolve()}});return deferred.promise()},editUserInfo:function(user){var deferred=$.Deferred();var request=serializers.UserToRequest(user);request.PageToken=marketplace_consts.marketplaceToken;$.ajax({async:true,datatype:"json",cache:false,url:marketplace_consts.marketplaceLibraryDBID+"/(_DBID_Users)?act=QBI_Marketplace_Edit",data:request,success:function(){deferred.resolve()}});return deferred.promise()},getFileInfo:function(qbDBID){if(qbDBID==null||typeof qbDBID==undefined){return}var deferred=$.Deferred();$.ajax({async:true,datatype:"xml",cache:false,url:marketplace_consts.marketplaceLibraryDBID+"/(_DBID_Assets)?a=API_DoQuery&query={"+MARKETPLACE_LIBRARY_SCHEMA.ASSETS.DBID+".EX.'"+qbDBID+"'}&fmt=structured&includeRids=true"}).pipe(function(resp){if(resp&&$("qdbapi errcode",resp).text()==0){var fileRecord={};var files=[];$("record",resp).each(function(index,fileXML){fileRecord.rid=($(fileXML).attr("rid"));$("f",fileXML).each(function(index,f){var file={};file.fid=$(f).attr("id");file.url=$("url",f).text();files.push(file)});fileRecord.files=files;return false});deferred.resolve(fileRecord)}else{deferred.reject()}});return deferred.promise()},addFileURL:function(versionRID){if(versionRID==null||typeof versionRID==undefined){return""}return marketplace_consts.marketplaceLibraryDBID+"/(_DBID_Assets)?a=QBI_Marketplace_Add&_fnm_related_version="+versionRID+"&pagetoken="+marketplace_consts.marketplaceToken},editFileURL:function(versionRID,assetRID){if(versionRID==null||typeof versionRID==undefined||assetRID==null||typeof assetRID==undefined){return""}return marketplace_consts.marketplaceLibraryDBID+"/(_DBID_Assets)?a=QBI_Marketplace_Edit&_fnm_related_version="+versionRID+"&rid="+assetRID+"&pagetoken="+marketplace_consts.marketplaceToken},getIcons:function(tableInformation,maxIcons){if(tableInformation==null||typeof tableInformation==undefined){return""}if(maxIcons==null||typeof maxIcons==undefined){maxIcons=7}var icons="";var i;for(i=0;i<maxIcons&&i<tableInformation.length;i++){icons+="<span data-original-title='"+HTMLEncode(tableInformation[i].name)+"' class='Tipsy TblIcon16 "+tableInformation[i].icon+"'></span>"}if(i<tableInformation.length&&tableInformation.length>0){icons+="<span class='Tipsy CursorPointer ColorLinkBlue' data-original-title='Click Details to show all the tables in this app'>...</span>"}return icons},addActivityLog:function(mktid){var deferred=$.Deferred();$.ajax({async:true,datatype:"json",cache:false,url:marketplace_consts.marketplaceLibraryDBID+"/(_DBID_ACTIVITY_LOG)?act=QBI_Marketplace_Add",data:{_fnm_marketplace_id:mktid,_fnm_num_of_downloads:1,PageToken:marketplace_consts.marketplaceToken,invalidCache:1},success:function(){deferred.resolve()}});return deferred.promise()},editActivityLog:function(data){var deferred=$.Deferred();var appRId=($(data).attr("rid"));var installs=parseInt($("num_of_downloads",data).text());$.ajax({async:true,datatype:"json",cache:false,url:marketplace_consts.marketplaceLibraryDBID+"/(_DBID_ACTIVITY_LOG)?act=QBI_Marketplace_Edit",data:{rid:appRId,_fnm_num_of_downloads:installs+1,PageToken:marketplace_consts.marketplaceToken,invalidCache:1},success:function(){deferred.resolve()}});return deferred.promise()},getActivityLog:function(mktid){var deferred=$.Deferred();$.ajax({async:true,datatype:"json",cache:false,url:marketplace_consts.marketplaceLibraryDBID+"/(_DBID_ACTIVITY_LOG)?a=API_DoQuery&includeRids=true&query={"+MARKETPLACE_LIBRARY_SCHEMA.ACTIVITY_LOG.MARKETPLACE_ID+".EX."+mktid+"}",success:function(data,textStatus,XMLHttpRequest){if($("qdbapi errcode",data).text()==0){deferred.resolve($("record",data))}}});return deferred.promise()},editInstalls:function(mktid){var deferred=$.Deferred();api.getActivityLog(mktid).then(function(resp){if(resp.length==0){api.addActivityLog(mktid).then(function(){deferred.resolve()})}else{api.editActivityLog(resp).then(function(){deferred.resolve()})}});return deferred.promise()},editApp:function(app){var deferred=$.Deferred();$.ajax({async:true,datatype:"json",cache:false,url:app.dbid+"?act=JBI_Marketplace_EditApp",data:{PageToken:marketplace_consts.marketplaceToken},success:function(copyAppResponse){if(copyAppResponse&&copyAppResponse.errcode==0){deferred.resolve(copyAppResponse)}else{deferred.reject(copyAppResponse)}}});return deferred.promise()},editAppCopyMetaInfo:function(app,newdbid){var deferred=$.Deferred();if(newdbid==null||typeof newdbid==undefined){return}var request=serializers.AppToRequest(app);var versionNumber=+app.version_number+1;$.extend(request,{_fnm_dbid:newdbid,_fnm_version_number:versionNumber,_fnm_status:api.STATE.DRAFT,_fnm_related_application:app.marketplace_id,PageToken:marketplace_consts.marketplaceToken});$.ajax({async:true,datatype:"json",cache:false,url:marketplace_consts.marketplaceLibraryDBID+"/(_DBID_Versions)?act=QBI_Marketplace_Add",data:request,success:function(resp){var rid=$(resp).find("rid").text();if(rid==undefined){deferred.reject(resp)}api.getFileInfo(app.dbid).then(function(fileRecord){var assetRid=fileRecord.rid;$.ajax({async:true,cache:false,url:marketplace_consts.marketplaceLibraryDBID+"/(_DBID_Assets)?a=QBI_Marketplace_CopyAssets",data:{_fnm_related_version:rid,rid:assetRid,PageToken:marketplace_consts.marketplaceToken},success:function(resp){var errcode=$(resp).find("errcode").text();if(errcode==0){deferred.resolve(resp)}}})})}});return deferred.promise()}};var serializers={VersionsToApp:function(appResponse){var app=serializers.PublishedToApp(appResponse);app.marketplace_id=$("related_application",appResponse).text();app.status=$("status",appResponse).text();var statusLower=app.status.toLowerCase();var isDraft=statusLower.indexOf(api.STATE.DRAFT.toLowerCase())!==-1;var isPending=statusLower.indexOf("pending")!==-1;var isRejected=statusLower.indexOf(api.STATE.REJECTED.toLowerCase())!==-1;var isPublished=statusLower.indexOf(api.STATE.PUBLISHED.toLowerCase())!==-1;var isEdit=!isPublished&&app.version_number!=1;app.hasInstalls=$("installs",appResponse).text()==""?false:true;app.ratings_width=parseInt(parseFloat($("ratings",appResponse).text())*20);if(isPending){app.isMyAppLocked=true;app.status="Pending";app.status_display="pending";app.isPending=true}else{if(isPublished){app.isPublished=true;app.isMyAppLocked=true;var today=new Date();var duration=new Date(today.getFullYear(),today.getMonth(),today.getDate()-7);if($("date_published",appResponse).text()>=duration.getTime()){app.status="JustPublished"}}else{if(isRejected){app.isRejected=true;app.isMyAppLocked=false}else{if(isDraft){app.isDraft=true}}}}if(isEdit){app.isEdit=true;app.isDraft=false;app.isEditRejected=isRejected;app.isRejected=false;app.isPending=false}app.status_display=app.status.toLowerCase();return app},PublishedToApp:function(appResponse){var kMaxAppName=39;var kMaxDesc=97;var anApp={};anApp.app_name_full=$("app_name",appResponse).text();anApp.app_description_full=$("app_description",appResponse).text();anApp.categories=$("categories",appResponse).text();anApp.marketplace_id=$("marketplace_id",appResponse).text();if($("ratings",appResponse).text()==""){anApp.ratings=false}else{anApp.ratings=parseInt($("ratings",appResponse).text())}anApp.submitter_name=$("nickname",appResponse).text();anApp.dbid=$("dbid",appResponse).text();anApp.keywords=$("keywords",appResponse).text();anApp.installs=$("installs",appResponse).text();anApp.hasInstalls=$("installs",appResponse).text()==""?false:true;anApp.date_published=marketplaceUtils.getDateFormat($("date_published",appResponse).text());anApp.date_created=marketplaceUtils.getDateFormat($("date_created",appResponse).text());anApp.app_name=marketplaceUtils.truncate(anApp.app_name_full,kMaxAppName);anApp.app_description=marketplaceUtils.truncate(anApp.app_description_full,kMaxDesc);anApp.qsp=$("quickbase_provider",appResponse).text()=="1";anApp.forEssential=$("make_available_for_essential_plan_user",appResponse).text()=="1";anApp.date_picked_as_staff_pick=marketplaceUtils.getDateFormat($("date_picked_as_staff_pick",appResponse).text());anApp.isStaffPick=(anApp.date_picked_as_staff_pick!="");anApp.current_staff_pick=$("current_staff_pick",appResponse).text()=="1";if(anApp.isStaffPick){anApp.staff_pick_quote=$("staff_pick_quote",appResponse).text()}var tableInfo=$("table_information",appResponse).text();anApp.tableInformation="";try{anApp.tableInformation=$.parseJSON(tableInfo)}catch(err){}anApp.icons=api.getIcons(anApp.tableInformation,6);anApp.version_number=$("version_number",appResponse).text();anApp.UID=$("uid",appResponse).text();return anApp},AppToRequest:function(app){var request={rid:app.rid,marketplace_id:app.marketplace_id,dbid:app.dbid,_fnm_app_Name:app.app_name,_fnm_app_description:app.app_description,_fnm_keywords:app.keywords,_fnm_categories:app.categories,_fnm_status:app.status,_fnm_table_information:JSON.stringify(app.tableInformation),_fnm_account_plan_name:!_.isUndefined(app.acctplanname)?app.acctplanname:""};return request},ResponseToUser:function(userResponse){var user={};user.uid=$("uid",userResponse).text();user.email=$("email",userResponse).text();user.firstName=$("first_name",userResponse).text();user.lastName=$("last_name",userResponse).text();user.nickName=$("nickname",userResponse).text();user.businessWebsite=$("company_website",userResponse).text();user.title=$("title",userResponse).text();user.quickBaseUserSince=$("quickbase_user_since",userResponse).text();user.quickBaseAppsCreated=$("quickbase_apps_created",userResponse).text();user.quickBaseAppsShared=$("quickbase_apps_shared",userResponse).text();user.additionalInfo=$("additional_info",userResponse).text();user.showInitial=$("show_initial_only",userResponse).text();user.company=$("company",userResponse).text();user.draft=$("draft",userResponse).text();user.qsp=$("quickbase_provider",userResponse).text()=="1";return user},UserToRequest:function(user){if($.isEmptyObject(user)){return{}}var request={key:user.uid,_fnm_uid:user.uid,_fnm_email:user.email,_fnm_first_name:user.firstName,_fnm_last_name:user.lastName,_fnm_nickname:user.nickName,_fnm_company_website:user.businessWebsite,_fnm_title:user.title,_fnm_years_in_business:user.years_in_business,_fnm_quickBase_user_since:user.quickBaseUserSince,_fnm_quickbase_apps_created:user.quickBaseAppsCreated,_fnm_additional_info:user.additionalInfo,_fnm_show_initial_only:user.showInitial,_fnm_company:user.company,_fnm_draft:user.draft,_fnm_internal_email:marketplace_consts.QBUser.QBEmail};return request},ResponseToCategory:function(categoryResponse){var category={};category.name=$("name",categoryResponse).text();return category}};var utils={addToApplications:function(app){if(marketplace_consts.marketplaceToken==null||typeof marketplace_consts.marketplaceToken==undefined){return}var deferred=$.Deferred();$.ajax({async:true,datatype:"json",cache:false,url:marketplace_consts.marketplaceLibraryDBID+"/(_DBID_APPLICATIONS)?act=QBI_Marketplace_Add",data:{_fnm_original_app_dbid:app.dbid,_fnm_related_submitter:app.related_submitter,_fnm_current_version_number:1,PageToken:marketplace_consts.marketplaceToken}}).pipe(function(resp){var marketplace_APPID=$(resp).find("marketplace_APPID").text();if(!marketplace_APPID){deferred.reject()}else{deferred.resolve(marketplace_APPID)}});return deferred.promise()},addToVersions:function(app){if(marketplace_consts.marketplaceToken==null||typeof marketplace_consts.marketplaceToken==undefined){return}var deferred=$.Deferred();$.ajax({async:true,datatype:"json",cache:false,url:marketplace_consts.marketplaceLibraryDBID+"/(_DBID_Versions)?act=QBI_Marketplace_Add",data:{_fnm_dbid:app.dbid,_fnm_version_number:"1",_fnm_status:app.status,_fnm_app_name:app.dbname,_fnm_app_description:app.app_description,_fnm_related_application:app.marketplace_APPID,_fnm_table_information:marketplaceUtils.tableInformationToRequest(gTablesJSON),PageToken:marketplace_consts.marketplaceToken},success:function(){deferred.resolve()}});return deferred.promise()}};return api});