var gSaveBanner;var gSaveBannerInited=false;var kVPmodeNormal=0;var kVPmodeMovePending=1;var kVPmodeMoveActive=2;var kVPmodeResizePending=3;var kVPmodeResizeActive=4;var kVPauto=0;var kVPleft=1;var kVPcenter=2;var kVPright=3;var kVPnowrap=1;var kVPwrap=2;var kVPfixed=3;var kOpt_WithATUparams=1;var gVPmoveCursor=null;var gInHeadCell=null;var gHilitHeadCell=null;var gMdownHeadCell=null;var gViewFID=null;var gViewDBID=null;var gViewQID=null;var gViewCell=null;var gViewTable=null;var gViewColIndex=-1;var gVPviews=new Array();var gViewIsNew=false;var gViewIsModified=false;var gUserCanView=true;var gTableHomeIsDefaultCantSave=false;var gViewIsShared=null;var gViewSvShared=null;var gReqQID=0;var doneSetupReportContainers=false;var gDynamicTempQID=-1;function IsStandaloneView(){return typeof gIsStandardViewPage!="undefined"}function IsTableDashboardView(){return typeof gForTableDashboard!="undefined"}function IsNewDashboardView(){return !!window.QB&&!!window.QB.Dashboard}function vpInitTable(tableOrID){var table=toElem(tableOrID);if(!table){return}if(Modernizr.touch){$(table).find(".FieldHasMenu").bind("touchstart touchend",vpTouchContextMenu)}gVPviews.push(table);table.qbDBID=GetHTMLattribute(table,"qbDBID");table.qbQID=GetHTMLattribute(table,"qbQID");table.qbIsShared=GetHTMLattribute(table,"qbIsShared");table.qbIsFrgnPV=GetHTMLattribute(table,"qbIsFrgnPV");table.qbRIDlistID=GetHTMLattribute(table,"qbRIDlistID");table.qbOrigDelta=GetHTMLattribute(table,"qbDeltas");table.qbGExtra=GetHTMLattribute(table,"qbGExtra");table.qbATUparams=GetHTMLattribute(table,"qbATUparams");table.qbSortInfo=GetHTMLattribute(table,"qbSortInfo");table.qbRightOff=GetHTMLattribute(table,"qbRightOff",18);table.qbDefDFID=GetHTMLattribute(table,"qbDefDFID");table.qbCanExp=GetHTMLattribute(table,"qbCanExp",false);table.qbCanExpToTab=GetHTMLattribute(table,"qbCanExpToTab",false);table.qbCanDel=GetHTMLattribute(table,"qbCanDel",false);table.qbMRops=GetHTMLattribute(table,"qbMRops",false);table.qbCanAdmin=GetHTMLattribute(table,"qbCanAdmin",false);table.qbClrFlags=GetHTMLattribute(table,"qbClrFlags",false);table.qbSubscr=GetHTMLattribute(table,"qbSubscr");table.qbSomeMod=GetHTMLattribute(table,"qbSomeMod");table.qbSvShared=GetHTMLattribute(table,"qbSvShared");table.qbTBtext=GetHTMLattribute(table,"qbTBtext");table.qbCanPrint=GetHTMLattribute(table,"qbCanPrint");table.qbCanEmail=GetHTMLattribute(table,"qbCanEmail");table.qbHasCalen=GetHTMLattribute(table,"qbHasCalen",false);table.qbHasTimln=GetHTMLattribute(table,"qbHasTimln",false);table.qbIsMini=GetHTMLattribute(table,"qbIsMini",false);var viewType=GetHTMLattribute(table,"qbVwType",0);table.IsTableView=(viewType==1);table.IsSummary=(viewType==2);table.IsCrossTab=(viewType==3);table.IsChart=(viewType==4);table.IsCalendar=(viewType==5);table.IsTimeline=(viewType==6);table.IsNewSummary=(viewType==9);table.IsTableWithSummaryOnly=(table.IsTableView)&&GetHTMLattribute(table,"qbIsSummaryView",false);if(table.IsTimeline){table.qbTimelineStart=GetHTMLattribute(table,"qbTimelineStart");table.qbTimelineEnd=GetHTMLattribute(table,"qbTimelineEnd")}var a=GetHTMLattribute(table,"qbQparams").split(",");table.qbSkipCount=a[0];table.qbRecsPerPage=a[1];table.qbRecsShown=a[2];table.qbRecsMatch=a[3];table.qbMaxHeight=a[4];table.qbScrollX=a[5];table.qbAccountID=a[6];if(!_.isUndefined(gDynamicTempQID)&&GetHTMLattribute(table,"qbDynamicQID")!=null){gDynamicTempQID=GetHTMLattribute(table,"qbDynamicQID")}table.qbDBID=GetHTMLattribute(table,"qbDBID");var numFrozCols=1;if(table.IsTableView||table.IsSummary){numFrozCols=2}else{if(table.IsTimeline){var numDataFields=Number(GetHTMLattribute(table,"qbNumDataCols"));numFrozCols=numDataFields}}var numFrozRows=(table.IsCrossTab?2:1);if(!Modernizr.touch&&IsStandaloneView()&&typeof kScroller!="undefined"){kScroller=new Scroller(table.id,null,false,0,numFrozCols,0,numFrozRows);table.qbScroller=null}else{kScroller=null;table.qbScroller=new Scroller(table.id,QBselectParentNode(table,"div"),false,0,numFrozCols,0,numFrozRows)}if((IsChrome()||IsSafari())&&!table.IsCalendar){$(table).find("tr").each(function(){if(!$(this).hasClass("hd")){var rowBgColor=$(this).css("backgroundColor");for(i=0;i<numFrozCols;i++){$(this).children("td:eq("+i+")").css("backgroundColor",rowBgColor)}}})}var cells=table.rows[0].cells;for(var n=0;n<cells.length;++n){var cell=cells[n];var fid=GetHTMLattribute(cell,"qbFID");if(fid){cell.qbFID=fid}var cpropstr=GetHTMLattribute(cell,"qbCpropsStr");if(cpropstr){cell.qbCpropsStr=cpropstr}cell.downX=null}table.qbOrigFIDlist=vpGenFidList(table);HideOtherIfNeeded(table);ShowMiniBarItems(table)}function FindMiniBar(table){if(table.miniBar){return table.miniBar}var viewOuter;if(table.IsCalendar){viewOuter=QBselectParentNodeByClass(table,"div","viewOuter")}else{if(table.IsChart){viewOuter=QBselectParentNodeByClass(table,"table","viewOuter")}else{viewOuter=$(table).closest("table.viewOuter")}}if(viewOuter){if(table.IsCalendar){table.miniBar=QBselectSingleNode(viewOuter,"table/tbody/tr[1]/td/table/tbody/tr/td")}else{if(table.IsChart){table.miniBar=QBselectSingleNode(viewOuter,"tbody/tr[1]/td/table/tbody/tr/td")}else{table.miniBar=$(viewOuter).find("table.ToolbarTable").get(0)}}}return table.miniBar}function ShowMiniBarItems(table){var miniBar=FindMiniBar(table);if(miniBar){miniBar.style.visibility="visible"}}function HideOtherIfNeeded(table){ConfigureTableMenus(table);var menu=getElementBy("ViewOtherOps");if(!HasVisiblePick(menu)){var miniBar=FindMiniBar(table);if(miniBar){for(var n=0;n<10;++n){var button;if(table.IsNewSummary||table.IsTimeline){button=QBselectSingleNode(miniBar,"tbody[0]/tr[0]/td[0]/a["+n+"]")}else{if(table.IsTableView){button=QBselectSingleNode(miniBar,"tbody[0]/tr[0]/td["+n+"]/a[0]")}else{button=QBselectSingleNode(miniBar,"a["+n+"]")}}if(button&&StringStartsWith(button.innerHTML,"other")){closeElem(button);var divider;if(table.IsCalendar){divider=button.previousSibling.previousSibling}else{divider=button.previousSibling}if(divider){if(divider.nodeType==kTEXT_NODE){button.previousSibling.nodeValue=""}else{if(divider.nodeType==kELEMENT_NODE){closeElem(divider)}}}}}}}}function vpScrollProc(ev,div){var table=QBselectSingleNode(div,"table");if(table.qbScroller){table.qbScroller.AdjustFrozenRow();table.qbScroller.AdjustFrozenCol()}}function vpInitGlobals(table,cell){var dbid=table.qbDBID;var qid=table.qbQID;var fid=cell.qbFID;gViewFID=fid;gViewDBID=dbid;gViewQID=qid;gViewCell=cell;gViewTable=table;gViewColIndex=GetColumnIndex(table,cell);gViewFinfo=GetFinfo(gViewFID,gViewDBID,gViewQID)}function vpContextMenu(table,cell){if(cell.isMenuDown){HideMenus();return EvCancelAll()}vpInitGlobals(table,cell);var dbid=gViewDBID;var qid=gViewQID;var fid=gViewFID;CleanPopMenu("fpopmenu");var isSortable=IsFieldSortable(dbid,fid);var isCustomCol=(fid==kCustomColumnFID);var isRelevancyCol=(fid==kSomeFileRelevancyColumnFID);if(isSortable){var lo=GetLoMenuVal(dbid,fid);var hi=GetHiMenuVal(dbid,fid);SetInnerHTML("fpopSortUp","Sort "+lo+" to "+hi);SetInnerHTML("fpopSortDn","Sort "+hi+" to "+lo);SetInnerHTML("fpopGroupUp","Group "+lo+" to "+hi);SetInnerHTML("fpopGroupDn","Group "+hi+" to "+lo)}openCloseElem("fpopSortUp",isSortable);openCloseElem("fpopSortDn",isSortable);openCloseElem("fpopGroupUp",isSortable&&!isRelevancyCol);openCloseElem("fpopGroupDn",isSortable&&!isRelevancyCol);openCloseElem("fpopdiv1",isSortable);openCloseElem("fpopdiv2",isSortable&&!isRelevancyCol);var showAdminOps=(gViewTable.qbCanAdmin&&!isCustomCol&&!isRelevancyCol);openCloseElem("fpopField2Table",showAdminOps);openCloseElem("vpmEditProps",showAdminOps);openCloseElem("fpopdiv6",showAdminOps&&!isRelevancyCol);SetHREF("vpmEditProps",gViewDBID+"?a=mf&fid="+gViewFID);if(gViewTable.qbCanAdmin){SetColor("fpopField2Table",vpF2Tallow()?"":"#888")}cell.qbmenuproc="vpMenuHide";ShowMenu("fpopmenu",cell,true,13,"belowRight");cell.isMenuDown=true;return EvCancelAll()}function vpTouchContextMenu(ev){if(!gPageLoadComplete){return}var cell=this;if(ev.type=="touchstart"){if(cell.tapHoldTimeMet){clearTimeout(cell.tapHoldTimeMet);cell.tapHoldTimeMet=null}if(cell.isMenuDown){HideMenus();return EvCancelAll()}cell.tapHoldTimeMet=setTimeout(function(){cell.tapHoldTimeMet=null;var table=QBselectParentNode(cell,"table");return vpContextMenu(table,cell)},1000)}if(ev.type=="touchend"){if(cell.tapHoldTimeMet){clearTimeout(cell.tapHoldTimeMet);cell.tapHoldTimeMet=null}}}function buildContextMenu(ev,menuIcon){if(!gPageLoadComplete){return}var table=QBselectParentNode(menuIcon,"table");var cell=QBselectParentNode(menuIcon,"td");return vpContextMenu(table,cell)}function vpMdown(ev,cell){if(!gPageLoadComplete){return}var table=QBselectParentNode(cell,"table");gMdownHeadCell=cell;cell.downX=GetMouseX(ev);vpInitGlobals(table,cell);return EvCancelAll()}function GetRefFieldName(){if(gViewFinfo.IsReference()){return gViewFinfo.name}if(gViewFinfo.IsLookup()){var finfo=gTableInfo[gViewDBID].finfo;if(finfo[gViewFinfo.reffid]){return finfo[gViewFinfo.reffid].name}}return null}function vpMup(ev,cell){var table=QBselectParentNode(cell,"table");gMdownHeadCell=null;cell.downX=null}function vpMenuHide(how){if(how==kQBafterHide&&gHilitHeadCell){gHilitHeadCell.isMenuDown=false}}function GetLoMenuVal(dbid,fid){if(fid==kSomeFileRelevancyColumnFID){return"low"}if(fid>0){var finfo=GetFinfo(fid,dbid,gViewQID);if(IsFieldDateTime(dbid,fid)){return"oldest"}else{if(IsFieldTimeOfDay(dbid,fid)){return"oldest"}else{if(IsFieldNumeric(dbid,fid)){return"low"}else{if(IsFieldDuration(dbid,fid)){return"low"}else{if(IsFieldPhoneNumber(dbid,fid)){return"low"}else{if(IsFieldRecordID(dbid,fid)){return"low"}else{if(IsFieldCheckbox(dbid,fid)){return"unchecked"}}}}}}}}return"A"}function GetHiMenuVal(dbid,fid){if(fid==kSomeFileRelevancyColumnFID){return"high"}if(fid>0){var finfo=GetFinfo(fid,dbid,gViewQID);if(IsFieldDateTime(dbid,fid)){return"newest"}else{if(IsFieldTimeOfDay(dbid,fid)){return"newest"}else{if(IsFieldNumeric(dbid,fid)){return"high"}else{if(IsFieldDuration(dbid,fid)){return"high"}else{if(IsFieldPhoneNumber(dbid,fid)){return"high"}else{if(IsFieldRecordID(dbid,fid)){return"high"}else{if(IsFieldCheckbox(dbid,fid)){return"checked"}}}}}}}}return"Z"}function vpMover(ev,cell){var table=QBselectParentNode(cell,"table");if(table.vpMode==kVPmodeResizeActive||table.vpMode==kVPmodeResizePending){return EvCancelAll(ev)}gInHeadCell=cell;if(cell!=gHilitHeadCell&&gHilitHeadCell){vpDelite()}if(table.vpMode!=kVPmodeMoveActive){vpHilite(cell)}}function vpMout(ev,cell){if(cell==gHilitHeadCell&&!gHilitHeadCell.isMenuDown){vpDelite()}gInHeadCell=null}function vpMmove(ev,cell){var table=QBselectParentNode(cell,"table");if(table&&table.vpMode==kVPmodeMoveActive){vpMBmouseMove(ev);return false}if(gMdownHeadCell==null||cell!=gMdownHeadCell){return true}if(window.document.selection&&gMdownHeadCell){window.document.selection.empty()}if(cell==gInHeadCell){if(cell&&cell.downX){var x=GetMouseX(ev);var dist=Math.abs(x-cell.downX);if(dist>12){vpMoveModeEnter();vpMBmouseDown(ev,table);return false}}}return true}function vpHilite(cell){if(cell){gHilitHeadCell=cell;vpMoveModeExit()}}function vpDelite(){if(gHilitHeadCell){if(gHilitHeadCell.isMenuDown){HideMenus();gHilitHeadCell.isMenuDown=false}}gHilitHeadCell=null}function vpFindHeadCell(ev,table){var pt=FindCell(table,ev);if(pt&&pt.r==0){return table.rows[pt.r].cells[pt.c]}return null}function vpGenFidList(table){var s="";for(var n=0;n<table.rows[0].cells.length;++n){var cell=table.rows[0].cells[n];var vis=(cell.style.display!="none");var fid=cell.qbFID;if(fid&&vis){s+=fid+"."}}return s}function vpDisplaySaveBannerIfNeeded(table,otherChanges){var deltaArray=new Array();otherChanges=otherChanges||false;UpdateDeltaArray(deltaArray,table,"",0);OpenCloseSaveBanner(deltaArray.length>0||otherChanges)}var gInCell=null;function hdMover(ev,cell){cell.style.backgroundColor="#E1E1C2";if(gInCell!=null&&gInCell!=cell){HideMenus();gInCell=null}}function hdMmove(ev,cell){ColResizeMouseMove(ev,cell)}function hdMout(ev,cell){if(!cell.isMenuDown){cell.style.backgroundColor=""}}function hdMdown(ev,cell){ColResizeMouseDown(ev)}function hdMup(ev,cell){ColResizeMouseUp()}function OnchangeCpropsWraps(){var showWidthEntry=(GetValue("cpropsWraps")==kVPfixed);hideShowElem("CwidthSpan",showWidthEntry);var cpropsWidth=getElementBy("cpropsWidth");if(showWidthEntry&&IsReallyVisible(cpropsWidth)){SetFocus(cpropsWidth);SetSelect(cpropsWidth)}}function GetFieldType(dbid,fid){var finfo=GetFinfo(fid,dbid,gViewQID);return finfo.type}function IsFieldDateTime(dbid,fid){return(GetFieldType(dbid,fid)=="DT"||GetFieldType(dbid,fid)=="TM"||GetFieldType(dbid,fid)=="WD")}function IsFieldNumeric(dbid,fid){return(GetFieldType(dbid,fid)=="NM")}function IsFieldCheckbox(dbid,fid){return(GetFieldType(dbid,fid)=="CB")}function IsFieldVcard(dbid,fid){return(GetFieldType(dbid,fid)=="VC")}function IsFieldIcal(dbid,fid){return(GetFieldType(dbid,fid)=="IC")}function IsFieldDuration(dbid,fid){return(GetFieldType(dbid,fid)=="DU")}function IsFieldRecordID(dbid,fid){return(GetFieldType(dbid,fid)=="RI")}function IsFieldPhoneNumber(dbid,fid){return(GetFieldType(dbid,fid)=="PH")}function IsFieldTimeOfDay(dbid,fid){return(GetFieldType(dbid,fid)=="TD")}function IsFieldSortable(dbid,fid){return(!IsFieldVcard(dbid,fid)&&!IsFieldIcal(dbid,fid))}function hdClick(cell,fid,dbid,qid){var loc=sortURLs[fid];if(loc){location=loc}}function vpGetHeadcellText(cell){var subtable=QBselectSingleNode(cell,"table");if(subtable){var subcell=QBselectSingleNode(subtable,"tbody/tr/td");if(subcell){return subcell.innerHTML}}return cell.innerHTML}function NukeSubstr(s,substr){var p=s.indexOf(substr);if(p>=0){return s.substr(0,p)+s.substr(p+substr.length,s.length-p)}return s}function HiliteColumn(table,colIndex){if(!table||colIndex<0){return}for(var n=1;n<table.rows.length;++n){var row=table.rows[n];if(IsNormalRow(table,row)){var bcolor=row.style.backgroundColor;if(!bcolor){var styleDef=CSSfindStyleDef("tr."+row.className);if(styleDef){bcolor=styleDef.backgroundColor}}if(bcolor){row.cells[colIndex].style.backgroundColor=GetBlend("#f6f6e0",bcolor,0.01)}}}}function DeliteColumn(table,colIndex){if(!table||colIndex<0){return}for(var n=1;n<table.rows.length;++n){var row=table.rows[n];if(IsNormalRow(table,row)){row.cells[colIndex].style.backgroundColor=""}}}function IsNormalRow(table,row){return row.cells.length==table.rows[0].cells.length}function vpSetColumnDisplay(table,colIndex,val){for(var n=0;n<table.rows.length;++n){var row=table.rows[n];if(IsNormalRow(table,row)){row.cells[colIndex].style.display=val}else{if(gViewTable.IsTimeline){var cell=row.cells[0];if(val=="none"){cell.colSpan-=1}}}}}function vpFidToColIndex(table,fid){var numCols=table.rows[0].cells.length;for(var n=0;n<numCols;++n){var cell=table.rows[0].cells[n];if(fid==cell.qbFID){return n}}return -1}var kVPsortUp="su";var kVPsortDown="sd";var kVPgroupUp="gu";var kVPgroupDown="gd";var kVPsortMore="sm";var kVPcolHeading="hd";var kVPcolWidth="wd";var kVPcolWrap="wc";var kVPcolWrapHead="wh";var kVPcolJust="ju";var kVPmode="mo";var kVPprint="pr";var kVPexportSS="xs";var kVPfidList="fl";var MAX_CUSTOM_HEADER_SIZE=300;function vpSort(op){vpUpdateSection(gViewTable,BuildDeltaParam(gViewTable,op,gViewFID),BuildEmbParams(gViewTable,0));return false}function vpHideColumn(){HideMenus();vpDelite();var row=gViewTable.rows[1];vpSetColumnDisplay(gViewTable,gViewColIndex,"none");vpDisplaySaveBannerIfNeeded(gViewTable);$(window).trigger("updateStickyHeaders");return false}function vpShowColumn(){HideMenus();var fieldSelector=new FieldSelector(gViewDBID,vpOFfieldSelectedCallback,vpDoShowColumns,true,null,null);fieldSelector.ShowPopup();return;var colpicker=new vpColumnPicker();colpicker.visColumns=new Object();var numCols=gViewTable.rows[0].cells.length;for(var n=1;n<numCols;++n){var cell=gViewTable.rows[0].cells[n];var vis=(cell.style.display!="none");var fid=cell.qbFID;if(fid){colpicker.visColumns[fid]=(vis?"v":"h")}}colpicker.isVisibleColumn=vpIsVisibleColumn;colpicker.onOKfunc=vpDoShowColumns;colpicker.open();return false}function vpDoShowColumns(fids){var x=gViewColIndex;var needsRefresh=false;for(var n=0;n<fids.length;++n){var fid=fids[n];var colIndex=vpFidToColIndex(gViewTable,fid);if(colIndex==-1){needsRefresh=true;x=vpInsertBlankColumn(gViewTable,x,gViewDBID,fid)}else{x=vpMoveColFromTo(gViewTable,colIndex,x)}vpSetColumnDisplay(gViewTable,x,"")}if(needsRefresh){vpUpdateSection(gViewTable,BuildDeltaParam(gViewTable),BuildEmbParams(gViewTable))}$(window).trigger("updateStickyHeaders");vpDisplaySaveBannerIfNeeded(gViewTable)}function vpIsVisibleColumn(colpicker,finfo,fid){var vis=(colpicker.visColumns[fid]?colpicker.visColumns[fid]:"");if(vis=="v"){return true}return false}var gVPcolumnPicker=null;function vpColumnPicker(){this.isVisibleColumn=null;this.foreignFieldFunc=null;this.onOKfunc=null}vpColumnPicker.prototype.open=function(){HideMenus();return false};function PopulateFields4Table(dbid,qid,mainDBID,columnPicker){FINFOgetAll(dbid);var fidsToList=gTableInfo[dbid].GetSortedFieldArray(null,qid);var columnPickerTable=$("#fieldListTable");if(_.isElement(columnPickerTable.get(0))){columnPickerTable.empty()}else{columnPickerTable=$("<div id='fieldListTable'></div>")}for(var n=0;n<fidsToList.length;++n){var fid=fidsToList[n];var fi=GetFinfo(fid,dbid,qid);if(!fi.IsReportable()){continue}if(!(fi.IsLookupable()||dbid==mainDBID)){continue}var fname=fi.name;if(fid==kCustomColumnFID){fname+=" &lt;custom&gt;"}if(fid==kSomeFileRelevancyColumnFID){fname+=" "+HTMLEncode(kFileRelevancyColumnAlias)}var label=$("<label for='cb"+fid+"'></label>");var span4Name=$("<span>"+fname+"</span>");var checkbox=$("<input type='checkbox' id='cb"+fid+"' />");var checked=((columnPicker&&columnPicker.isVisibleColumn)?columnPicker.isVisibleColumn(columnPicker,fi,fid):false);if(checked){checkbox.attr("checked","checked");checkbox.attr("disabled","disabled");label.addClass("Disabled")}label.append(span4Name);label.prepend(checkbox);columnPickerTable.append(label)}columnPickerTable.appendTo($("#fieldListholder"))}function OpenForeignColPicker(checkbox){checkbox.checked=false;gVPcolumnPicker.foreignFieldFunc(gVPcolumnPicker)}function onClickPickCols(){var columnPicker=$("#fieldListTable");var checkedBoxes=columnPicker.find("input:not(:disabled):checked");var fids=new Array();_.each(checkedBoxes,function(elem){fids.push($(elem).attr("id").substr(2))});gVPcolumnPicker.onOKfunc(fids)}function vpOFfieldSelectedCallback(OFsel,dbid,fid,isnew){vpInsertBlankColumn(gViewTable,gViewColIndex,dbid,fid);vpUpdateSection(gViewTable,BuildDeltaParam(gViewTable),BuildEmbParams(gViewTable))}function ColumnProps(rhs){if(rhs){this.heading=rhs.heading;this.width=rhs.width;this.wrap=rhs.wrap;this.just=rhs.just}else{this.heading="";this.width=0;this.wrap=kVPauto;this.just=kVPauto}}function vpInitCellCprops(cell){var props=gViewCell.qbCprops;if(!props){gViewCell.qbCprops=new ColumnProps();props=gViewCell.qbCprops;var propsStr=gViewCell.qbCpropsStr;if(propsStr){props.heading=GetAVPfromString(propsStr,kVPcolHeading,"");props.width=GetAVPfromString(propsStr,kVPcolWidth,0);props.wrap=GetAVPfromString(propsStr,kVPcolWrap,kVPauto);props.just=GetAVPfromString(propsStr,kVPcolJust,kVPauto)}}}function vpShowColumnProps(){vpInitCellCprops(gViewCell);vpDelite();SetInnerHTML("CpropsFieldLabel",gViewFinfo.name);var props=gViewCell.qbNewCprops;if(!props){props=gViewCell.qbCprops}var propsHeading=HTMLDecode(props.heading);if(propsHeading.length>MAX_CUSTOM_HEADER_SIZE){propsHeading=propsHeading.substring(0,MAX_CUSTOM_HEADER_SIZE)}SetValue("cpropsHeading",propsHeading);SetValue("cpropsJust",props.just);QB.Dialog.confirm({size:650,contents:$("#vpColumnPropsDiv"),contentType:"selector",id:"vpColumnProps",focusedButton:null,confirm:{text:"OK",focused:false,click:function(){vpDoSetColumnProps();$(this).dialog("close")}},cancel:{focused:false,click:function(){$(this).dialog("close")}}});return false}function vpDoSetColumnProps(){var newHeading=$.trim(GetValue("cpropsHeading"));if(newHeading.indexOf("~")>=0){QBalert("Column headings may not contain the ~ character");return}var newWidth=GetValue("cpropsWidth");if(isNaN(Number(newWidth))){QBalert("The column width must be a number.");return}gViewCell.qbNewCprops=new ColumnProps();var newProps=gViewCell.qbNewCprops;if(newHeading.length>MAX_CUSTOM_HEADER_SIZE){newHeading=newHeading.substring(0,MAX_CUSTOM_HEADER_SIZE)}newProps.heading=newHeading;newProps.just=GetValue("cpropsJust");if(newProps.heading==""){$(gViewCell).find(".ColumnHeading").html(HTMLEncode(gViewFinfo.name))}else{$(gViewCell).find(".ColumnHeading").html(HTMLEncode(newProps.heading))}var just=gViewFinfo.Justification();if(newProps.just==kVPleft){just="left"}if(newProps.just==kVPcenter){just="center"}if(newProps.just==kVPright){just="right"}SetColumnStyle(gViewTable,gViewColIndex,"textAlign",just);vpDisplaySaveBannerIfNeeded(gViewTable);HidePopupDiv("vpColumnProps")}function DoAutoExpl(){QBalert("Auto means that QuickBase should determine the value of a property automatically based on normal defaults or the settings in the field properties for the field being shown in that column.");return false}var gSMdivStack=null;function vpSortMore(){vpDelite();var rowsDiv=getElementBy("vpSortMoreRows");var line0=QBselectSingleNode(rowsDiv,"div");var fieldMenu0=QBselectSingleNode(line0,"select");var sortinfo=gViewTable.qbSortInfo.split(".");fieldMenu0.options.length=0;FINFOgetAll(gViewDBID);var fidsToList=gTableInfo[gViewDBID].GetSortedFieldArray(null,gViewQID);var sortedFields=[];for(var index=0;index<sortinfo.length;++index){var s=sortinfo[index];if(s==""){continue}sortedFields[s.substr(2)]=true}AppendMenuOption(fieldMenu0,"Select a field...",0,true);for(var n=0;n<fidsToList.length;++n){var fid=fidsToList[n];if(IsFieldSortable(gViewDBID,fid)){var finfo=GetFinfo(fid,gViewDBID,gViewQID);if((!finfo.IsReportable()&&!sortedFields[fid])||finfo.type=="IC"||finfo.type=="VC"||(finfo.type=="LK"&&finfo.HasFormula())||finfo.type=="XD"){continue}var fname=finfo.name;if(fid==kCustomColumnFID){fname+=" <custom>"}if(fid==kSomeFileRelevancyColumnFID){fname+=" "+kFileRelevancyColumnAlias}AppendMenuOption(fieldMenu0,fname,fid);if(!finfo.IsReportable()){$(fieldMenu0).children("option:last").addClass("redCritOpt")}}}for(var n=1;n<1000;++n){var line=QBselectSingleNode(rowsDiv,"div[1]");if(line==null){break}rowsDiv.removeChild(line)}for(var k=0;k<sortinfo.length;++k){var s=sortinfo[k];if(s==""){continue}var dir=s.charAt(0);var gbtype=s.charAt(1);var fid=s.substr(2);var canBeGrouped=(k<3);var grouping=(gbtype!="X"&&canBeGrouped);var sortmenuVal=(grouping?"g":"s")+dir;var line=line0;if(k!=0){line=line0.cloneNode(true);rowsDiv.appendChild(line)}var p=vpGetLineParts(line);if(grouping){var ftype=GetFieldType(gViewDBID,fid);BuildGroupingMenu(ftype,p.groupmenu);SetValue(p.groupmenu,gbtype)}hideShowElem(p.groupspan,grouping);SetValue(p.fieldmenu,fid);SetValue(p.sortmenu,sortmenuVal);onChangeVPsortFid(p.fieldmenu)}gSMdivStack=new DivStack("vpSortMoreRows");gSMdivStack.SetSelectionChangeCB(VPsortMoreSelectionChangeCB);gSMdivStack.SetClearLineCB(VPsortMoreClearLineCB);gSMdivStack.SetMoveUpButton("vpSortMoveUpBut");gSMdivStack.SetMoveDownButton("vpSortMoveDownBut");gSMdivStack.SetInsertButton("vpSortInsertBut");gSMdivStack.SetRemoveButton("vpSortRemoveBut");HideMenus();QB.Dialog.confirm({title:"Sorting & Grouping",size:650,contents:$("#vpSortMoreDiv"),contentType:"selector",id:"qbDialogSortingGrouping",focusedButton:null,confirm:{text:"OK",focused:false,click:function(){vpDoSortMore();$(this).dialog("close")}},cancel:{focused:false,click:function(){$(this).dialog("close")}}});return false}function VPsortMoreSelectionChangeCB(newselection){hideShowElem("vpSortMoreExtraButs",newselection!=null)}function VPsortMoreClearLineCB(line){var p=vpGetLineParts(line);SetValue(p.fieldmenu,0);onChangeVPsortFid(p.fieldmenu)}function vpGetLineParts(line){var obj=new Object();obj.fieldmenu=QBselectSingleNode(line,"select");obj.sortmenu=QBselectSingleNode(line,"select[1]");obj.groupspan=QBselectSingleNode(line,"span");obj.groupmenu=QBselectSingleNode(obj.groupspan,"select");return obj}function onChangeVPsortFid(fieldmenu,autoDeselect){var p=vpGetLineParts(QBselectParentNode(fieldmenu,"div"));var fid=GetValue(p.fieldmenu);var lo=GetLoMenuVal(gViewDBID,fid);var hi=GetHiMenuVal(gViewDBID,fid);SetMenuOptionText(p.sortmenu,"su","Sort "+lo+" to "+hi);SetMenuOptionText(p.sortmenu,"sd","Sort "+hi+" to "+lo);SetMenuOptionText(p.sortmenu,"gu","Group "+lo+" to "+hi);SetMenuOptionText(p.sortmenu,"gd","Group "+hi+" to "+lo);onChangeVPsortHow(p.sortmenu);updateSelectForInvalidOption(fieldmenu)}function onChangeVPsortHow(sortmenu){var p=vpGetLineParts(QBselectParentNode(sortmenu,"div"));var fid=GetValue(p.fieldmenu);if(fid>0){BuildGroupingMenu(GetFieldType(gViewDBID,fid),p.groupmenu)}hideShowElem(p.groupspan,IsGrouping(p.sortmenu))}function IsGrouping(sortmenu){var sortVal=GetValue(sortmenu);return(sortVal.charAt(0)=="g")}function GetSortDir(sortmenu){var sortVal=GetValue(sortmenu);return sortVal.charAt(1)}function ClickedSortCol(evt){var elt=this;if(elt.isMenuDown){return EvCancelAll()}var table=QBselectParentNode(elt,"table");var dbid=table.qbDBID;var qid=table.qbQID;gViewFID=elt.qbFID;gViewDBID=dbid;gViewQID=qid;gViewCell=elt;gViewTable=table;var neworder=kVPsortUp;if($(elt).hasClass("SortAsc")){neworder=kVPsortDown}return vpSort(neworder)}function vpDoSortMore(){var rowsDiv=getElementBy("vpSortMoreRows");var s="";for(var n=0;n<1000;++n){var line=QBselectSingleNode(rowsDiv,"div["+n+"]");if(line==null){break}var canBeGrouped=(n<3);var p=vpGetLineParts(line);var sortdir=GetSortDir(p.sortmenu);var grouping=IsGrouping(p.sortmenu);if(grouping&&!canBeGrouped){QBalert("Grouping is only allowed on the first three lines.");return}if(grouping){var gbtype=GetValue(p.groupmenu)}else{gbtype="X"}var fid=GetValue(p.fieldmenu);if(fid>0||fid==kCustomColumnFID||fid==kSomeFileRelevancyColumnFID){if(s!=""){s+="."}s+=sortdir+gbtype+fid}}vpUpdateSection(gViewTable,BuildDeltaParam(gViewTable,kVPsortMore,s),BuildEmbParams(gViewTable,0))}var gDefnFIDs=new Array();var gAddnFIDs=new Array();var gTempFIDs=new Array();var gF2TtableName="";var gF2TtableNoun="";function vpF2Tallow(){if(gViewFinfo.IsSummary()){return false}if(gViewFinfo.IsBI()){return false}if(gViewFinfo.IsReference()){return false}if(gViewFinfo.reffid!=0){return false}if(gViewFinfo.type=="XD"){return false}if(gViewFinfo.type=="FV"){return false}if(gViewFinfo.type=="AD"){return false}if(gViewFinfo.IsComposite()||gViewFinfo.IsCompositeSubField()){return false}if(gViewFinfo.IsReplicated()){return false}if(gViewFinfo.HasFormula()&&gViewFinfo.type=="WD"){return false}if(gTableInfo[gViewDBID].kfid==gViewFID){return false}var table=gViewTable;table.qbIsLocked=GetHTMLattribute(table,"qbIsLocked",false);table.qbMaxLockedFid=GetHTMLattribute(table,"qbMaxLockedFid",false);if(table&&table.qbIsLocked&&parseInt(gViewFID)<=parseInt(table.qbMaxLockedFid)){return false}return true}function vpF2Tadd(defining){DisableElems("F2Tnext","F2Tcancel","F2Tfields","F2Taddn");HideMenus();FINFOgetAll(gViewDBID);SetInnerHTML("F2TsrcTableName",HTMLEncode(gTableInfo[gViewDBID].name));var fidsToList=new Array();var finfo=gTableInfo[gViewDBID].finfo;for(var fid in finfo){var doAdd=vpF2Tfilter(this,finfo,fid);if(doAdd){fidsToList.push(fid)}}gCompareFinfo=finfo;fidsToList.sort(compareFieldsByName);var mainSelect=getElementBy("F2TpickMain");if(mainSelect.options.length==0){for(var n=0;n<fidsToList.length;++n){var fid=fidsToList[n];var fi=finfo[fid];AppendMenuOption(mainSelect,fi.name,fid)}}CopyArray(gTempFIDs,gDefnFIDs);AppendArray(gTempFIDs,gAddnFIDs);var mainSel=toElem("F2TpickMain");var mainLen=mainSel.options.length;for(var n=0;n<mainLen;++n){var fid=mainSel.options[n].value;var disable=FIDarrayHas(gTempFIDs,fid);SetMenuOptionDisabled(mainSel,n,disable)}F2TbuildList();QB.Dialog.confirm({size:"auto",contents:$("#F2Tpickdiv"),contentType:"selector",id:"F2Tpick",focusedButton:null,confirm:{text:"OK",focused:false,click:function(){vpF2TokFields();$(this).dialog("close")}},cancel:{focused:false,click:function(){vpF2TcancelFields();$(this).dialog("close")}}});vpDelite()}function F2TclickMain(){var mainSel=toElem("F2TpickMain");var x=mainSel.selectedIndex;if(x!=-1){if(mainSel.options[x].disabled){mainSel.selectedIndex=-1;return false}}return true}function FIDarrayFind(fidarray,fid){for(var i=0;i<fidarray.length;++i){if(fidarray[i]==fid){return i}}return -1}function FIDarrayHas(fidarray,fid){return(FIDarrayFind(fidarray,fid)!=-1)}function FIDarrayAppend(fidarray,fid){if(!FIDarrayHas(fidarray,fid)){fidarray.push(fid)}}function FIDarrayPrepend(fidarray,fid){if(!FIDarrayHas(fidarray,fid)){fidarray.splice(0,0,fid)}}function FIDarrayRemove(fidarray,fid){var i=FIDarrayFind(fidarray,fid);if(i!=-1){fidarray.splice(i,1)}}function FIDarraySwap(fidarray,a,b){if(a<0||b<0){return false}if(a>=fidarray.length||b>=fidarray.length){return false}var afid=fidarray[a];fidarray[a]=fidarray[b];fidarray[b]=afid;return true}function F2Tswap(incr){var sel=getElementBy("F2TfieldList");var i=sel.selectedIndex;var success=FIDarraySwap(gTempFIDs,i,i+incr);F2TbuildList();if(success){sel.selectedIndex=i+incr}else{sel.selectedIndex=i}}function F2TbuildList(){var sel=toElem("F2TfieldList");sel.options.length=0;var finfo=gTableInfo[gViewDBID].finfo;for(var i=0;i<gTempFIDs.length;++i){var fid=gTempFIDs[i];var text=finfo[fid].name;if(FIDarrayHas(gDefnFIDs,fid)){text+=" *"}AppendMenuOption(sel,text,fid)}}function F2TaddField(){var mainSel=toElem("F2TpickMain");var fid=GetValue(mainSel);if(fid){FIDarrayAppend(gTempFIDs,fid);F2TbuildList();SetValue("F2TfieldList",fid);SetMenuOptionDisabled(mainSel,mainSel.selectedIndex,true);mainSel.selectedIndex=-1}}function F2TrmvField(){var sel=toElem("F2TfieldList");var fid=GetValue(sel);if(fid){FIDarrayRemove(gTempFIDs,fid);F2TbuildList();var mainSel=toElem("F2TpickMain");var i=EnableDisableMenuOption(mainSel,fid,true);if(i!=-1){mainSel.selectedIndex=i}}}function F2TupField(){F2Tswap(-1)}function F2TdownField(){F2Tswap(1)}function vpF2Tfilter(colpicker,finfo,fid){var fi=finfo[fid];if(fi.IsLookup()||fi.IsBI()||fi.HasFormula()||fi.IsSummary()||fi.type=="XD"||fi.type=="FV"||fi.type=="AD"||fi.IsComposite()||fi.IsCompositeSubField()){return false}return true}function vpF2Tgrey(colpicker,finfo,fid){if(colpicker.fids==gDefnFIDs){return(FIDarrayHas(gAddnFIDs,fid))}if(colpicker.fids==gAddnFIDs){return(FIDarrayHas(gDefnFIDs,fid))}}function vpF2Tcheck(colpicker,finfo,fid){return(typeof colpicker.fids[fid]!="undefined")}function vpF2TgetPoss(jax,r,c,n,numposs){var v=jax.GetValue("val"+r+"_"+c+"_"+n);var a=v.split("~!~");var txt=(a.length>0?a[0]:"");var cnt=(a.length>1?a[1]:"");txt=HTMLEncode(txt);if(numposs>1&&cnt!=""){cnt=" ("+cnt+")"}if(numposs==1){return txt}var val="<span style='color:red'>"+txt+cnt+"</span>";val+="<br>";return val}function vpF2TenableButtons(){EnableElems("F2Tcancel","F2Tfields","F2Taddn");EnableDisable(!gF2ThasMultiValues,"F2Tnext")}function vpF2TokFields(){$("#F2Tpick").dialog("close");vpF2TenableButtons();var tempDefn=new Array();var tempAddn=new Array();CopyArray(tempDefn,gDefnFIDs);CopyArray(tempAddn,gAddnFIDs);gDefnFIDs.length=0;gAddnFIDs.length=0;for(var n=0;n<gTempFIDs.length;++n){var fid=gTempFIDs[n];if(FIDarrayHas(tempDefn,fid)){gDefnFIDs.push(fid)}else{gAddnFIDs.push(fid)}}vpF2TanalyzeStart(true)}function vpF2TcancelFields(){vpF2TenableButtons()}function ClearAllProperties(obj){for(var n in obj){delete obj[n]}}function vpF2TanalyzeStart(fromPicker){if(!vpF2Tallow()){HideMenus();return false}if(!fromPicker){gDefnFIDs.length=0;gAddnFIDs.length=0;gDefnFIDs.push(gViewFID)}QBbusy("Analyzing...");setTimeout("vpF2Tanalyze()",20);return false}var gF2Tjax;var gF2ThasMultiValues;function vpF2Tanalyze(){var jax=gF2Tjax=JaxSyncCmd(gViewDBID+"?a=QBI_FieldToTable_Analyze&fid="+gViewFID+F2TbuildFIDparams());if(jax.errcode!=0){jax.ShowErrAlert();return}var numRows=Number(jax.GetValue("numRows"));if(numRows>200){QBbusy("Building display for "+numRows+" results.<br>This could take a while.<br><br>If a browser warning appear about a slow script, just click the Continue button.")}else{QBbusy("Building display...")}setTimeout("vpF2Tanalyze2()",20)}var gF2TcolumnInfo=new Array();var gF2TwarningInfo=new Array();function vpF2Tanalyze2(){var jax=gF2Tjax;var ttable=getElementBy("F2Tlist");var numRows=Number(gF2Tjax.GetValue("numRows"));var numCols=Number(gF2Tjax.GetValue("numCols"));var F2Tword1text="";var rx=2;var cx=1;var fname0=jax.GetValue("fname0","");F2Tword1text=numCols<=1?fname0+" field":numCols+" fields below";TableRemoveAllRows(ttable);TableBuildOut(ttable,numRows+rx,numCols+cx);gF2TwarningInfo.length=0;for(var x=0;x<1000;++x){var fldname=jax.GetValue("firfld"+x);var frmname=jax.GetValue("firfrm"+x);if(fldname==null){break}gF2TwarningInfo[x]=new Object();gF2TwarningInfo[x].fldname=fldname;gF2TwarningInfo[x].frmname=frmname}gF2TcolumnInfo.length=0;var row0=ttable.rows[0];row0.className="hd";SetInnerHTML(row0.cells[0],"&nbsp;");for(var c=0;c<numCols;++c){gF2TcolumnInfo[c]=new Object();gF2TcolumnInfo[c].name=jax.GetValue("fname"+c);gF2TcolumnInfo[c].fid=jax.GetValue("ffid"+c);gF2TcolumnInfo[c].multiVal=false;gF2TcolumnInfo[c].isDefining=(jax.GetValue("fdef"+c)=="1")}for(var r=0;r<numRows;++r){if(r%100==0){defaultStatus="populating rows: "+r}var newrow=ttable.rows[r+rx];var cell=newrow.cells[0];SetInnerHTML(cell,r+1);cell.style.padding="2px 10px";cell.style.borderBottom="1px solid #ccc";cell.style.width="1%";cell.style.color="#333";for(var c=0;c<numCols;++c){var numposs=jax.GetValue("numposs"+r+"_"+c,1);if(numposs>1){gF2TcolumnInfo[c].multiVal=true}if(numposs==1){val=vpF2TgetPoss(jax,r,c,0,numposs)}else{var val="";for(var n=0;n<numposs;++n){val+=vpF2TgetPoss(jax,r,c,n,numposs)}}if(val==""){val=" "}var cell=newrow.cells[c+cx];cell.style.padding="2px 5px 2px 5px";cell.style.borderBottom="1px solid #ccc";if(gF2TcolumnInfo[c].isDefining){cell.style.fontWeight="bold"}else{cell.style.color="#333"}cell.style.borderRight="1px solid #eee";cell.innerHTML=val}}gF2ThasMultiValues=false;var row1=ttable.rows[1];for(var c=0;c<numCols;++c){var cell=row0.cells[c+cx];SetInnerHTML(cell,gF2TcolumnInfo[c].name);cell.style.verticalAlign="top";cell.style.fontSize="90%";cell=row1.cells[c+cx];cell.style.padding="5px 5px 5px 20px";if(gF2TcolumnInfo[c].multiVal){gF2ThasMultiValues=true;SetInnerHTML(cell,"<a href='#'onclick='return ConformCol("+c+")'>Conform values for this column?</a>")}}if(gF2ThasMultiValues){SetInnerHTML(row1.cells[0],"&nbsp;");SetInnerHTML(row1.cells[1],"&nbsp;")}openCloseElem("F2TerrDiv",gF2ThasMultiValues);vpF2TenableButtons();gF2TtableName=SingularToPlural(jax.GetValue("fname0"));gF2TtableNoun=gF2TtableName;SetInnerHTML("F2Thead",gF2TtableName);SetInnerHTML("F2TinfoMsg",Numerize(numRows," record")+" will be created.");openCloseElem("F2TinfoDiv",!gF2ThasMultiValues);var odiv=QBselectParentNode(ttable,"div");odiv.scrollTop=0;var dialogTitle="Extract the ";dialogTitle+=F2Tword1text==""?"field below":F2Tword1text;dialogTitle+=" into a separate table";QB.Dialog.confirm({title:dialogTitle,size:"auto",contents:"#F2Tdiv",contentType:"selector",id:"F2T",focusedButton:null,extraButtons:[{text:"Additional Fields",type:"Plain",click:function(){$(this).dialog("close");vpF2Tadd(true)}}],confirm:{text:"Next",focused:false,click:function(){vpF2Twarning();$(this).dialog("close")}},cancel:{focused:false,click:function(){$(this).dialog("close")}}});QBbusyHide()}function F2TbuildFIDparams(){var fs="";var fa=new Array();for(var n=0;n<gDefnFIDs.length;++n){fa.push(gDefnFIDs[n])}if(fa.length>0){fs+="&defnfids="+fa.join(".")}fa.length=0;for(var n=0;n<gAddnFIDs.length;++n){fa.push(gAddnFIDs[n])}if(fa.length>0){fs+="&addnfids="+fa.join(".")}return fs}function vpF2TgetName(){QB.Dialog.confirm({size:430,contents:"#F2Tnamediv",contentType:"selector",id:"F2Tname",focusedButton:null,confirm:{focused:false,click:function(){vpF2Tcreate();$(this).dialog("close")}},cancel:{focused:false,click:function(){$(this).dialog("close")}}});SetValue("F2TtableName",gF2TtableName);SetValue("F2Tnoun",gF2TtableNoun)}function vpF2Twarning(){if(gF2TwarningInfo.length>0){var fflist="";for(var x=0;x<gF2TwarningInfo.length;++x){fflist+=" <li><b>"+HTMLEncode(gF2TwarningInfo[x].fldname)+"</b> is used in a rule on the form <b>"+HTMLEncode(gF2TwarningInfo[x].frmname)+"</b>.</li>"}if(fflist!=""){fflist="<ul>"+fflist+"</ul>"}QB.Dialog.confirm({size:430,title:"Warning",contents:"The fields below are used in rules on one or more forms in this application.  This operation turns the fields you've chosen into lookup fields and lookup fields do not work in form rules.<br><br> If you continue, these forms will no longer function.<br><br>"+fflist,contentType:"html",id:"F2TNormalWarning",focusedButton:null,confirm:{text:"Continue",focused:false,click:function(){vpF2TnormalWarning();$(this).dialog("close")}},cancel:{focused:false,click:function(){$(this).dialog("close")}}})}else{vpF2TnormalWarning()}}function vpF2TnormalWarning(){var srcTableName=gTableInfo[gViewDBID].name;QB.Dialog.confirm({size:430,title:"Warning",contents:"This operation removes the data in the columns you've specified from the <b>"+HTMLEncode(srcTableName)+"</b> table and places it into a new table.<br><br>While it may appear that the data still exists in the <b>"+HTMLEncode(srcTableName)+"</b> table, it does not.  If you delete the new table, the data will be lost.",contentType:"html",id:"F2TNormalWarning",focusedButton:null,confirm:{focused:false,click:function(){vpF2TgetName();$(this).dialog("close")}},cancel:{focused:false,click:function(){$(this).dialog("close")}}})}function vpF2Tcreate(){gF2TtableName=GetValue("F2TtableName");gF2TtableNoun=GetValue("F2Tnoun");var jax=new jaxreq(gViewDBID+"?a=QBI_FieldToTable_Create"+F2TbuildFIDparams());jax.AddValue("fid",gViewFID);jax.AddValue("tname",gF2TtableName);jax.AddValue("tpnoun",gF2TtableNoun);jax.DoSyncCmd();if(jax.errcode!=0){jax.ShowErrAlert();return}vpF2Thide();if(!IsStandaloneView()){RefreshPage();return}vpUpdateSection(gViewTable,BuildDeltaParam(gViewTable),BuildEmbParams(gViewTable))}function vpF2Thide(){HidePopupDiv("F2Tdiv");HidePopupDiv("F2Tname");HidePopupDiv("F2Thelp")}function ConformCol(c){var msg,callback,title;if(gF2TcolumnInfo[c].multiVal){msg="Do you want to conform the values in the <b>"+gF2TcolumnInfo[c].name+"</b> column?";callback=F2TconformColumn;title="Conform values"}else{if(gF2TcolumnInfo[c].isDefining){msg="Do you want to unconform the values in the <b>"+gF2TcolumnInfo[c].name+"</b> column?";callback=F2TunconformColumn;title="Unconform values"}}if(gF2TcolumnInfo[c].multiVal||gF2TcolumnInfo[c].isDefining){QB.Dialog.confirm({title:title,size:430,contents:msg,contentType:"html",id:"qbDialogConform",focusedButton:null,confirm:{focused:false,click:function(){callback(c);$(this).dialog("close")}},cancel:{focused:false,click:function(){$(this).dialog("close")}}})}return false}function F2TconformColumn(c){var fid=gF2TcolumnInfo[c].fid;FIDarrayRemove(gAddnFIDs,fid);FIDarrayAppend(gDefnFIDs,fid);vpF2Tanalyze()}function F2TunconformColumn(c){var fid=gF2TcolumnInfo[c].fid;FIDarrayRemove(gDefnFIDs,fid);FIDarrayPrepend(gAddnFIDs,fid);vpF2Tanalyze()}function vpSetColumnWidth(table,colIndex,newwidth){var s=table.id;for(var n=0;n<table.rows.length;++n){var row=table.rows[n];if(IsNormalRow(table,row)){row.cells[colIndex].style.width=newwidth}}}function vpSetColumnWrap(table,colIndex,wraps){for(var n=0;n<table.rows.length;++n){var row=table.rows[n];if(IsNormalRow(table,row)){row.cells[colIndex].noWrap=!wraps}}}function vpRZmouseDown(ev,table){var resizeBox=(table?table.resizeBox:this);resizeBox.qbTable.vpMode=kVPmodeResizeActive;resizeBox.qbFirstX=GetMouseX();return EvCancelAll(ev)}function vpRZmouseMove(ev){var table=gViewTable;var resizeBox=(table?table.resizeBox:this);if(table.vpMode==kVPmodeResizeActive){var x=GetMouseX(ev);var delta=x-resizeBox.qbFirstX;var c=table.resizeCol;var newwidth=(table.origColWidth+delta)+"px";vpSetColumnWidth(table,c,newwidth);vpSetColumnWrap(table,c,true);if(!gViewCell.qbNewCprops){vpInitCellCprops(gViewCell);gViewCell.qbNewCprops=new ColumnProps(gViewCell.qbCprops)}gViewCell.qbNewCprops.width=newwidth;gViewCell.qbNewCprops.wrap=kVPfixed;var cell0=table.rows[1].cells[c];resizeBox.style.left=(GetElemRight(cell0)-5)+"px";ldiv("x="+x+"     delta= "+delta+"    cell.style.width="+cell0.style.width+"   cell.offsetWidth="+cell0.offsetWidth+"  orig="+table.origColWidth+" "+table.origColStyleWidth);return EvCancelAll(ev)}}function vpRZmouseUp(ev){var table=gViewTable;vpMoveModeExit();vpDisplaySaveBannerIfNeeded(table);return EvCancelAll(ev)}function vpMBmouseDown(ev,table){var movebox=(table?table.moveBox:this);var left=parseInt(movebox.style.left,10);movebox.qbTable.vpMode=kVPmodeMoveActive;movebox.qbMoveBoxOffset=GetMouseX()-left;return EvCancelAll(ev)}function vpMBmouseMove(ev){var table=gViewTable;var movebox=table.moveBox;if(table.vpMode==kVPmodeMoveActive){var x=GetMouseX(ev);movebox.style.left=(x-movebox.qbMoveBoxOffset)+"px";var csides=table.csides;for(var n=0;n<csides.length-1;++n){if(x>csides[n]&&x<csides[n+1]){var loff=x-csides[n];var roff=csides[n+1]-x;var k=(loff<roff?n:n+1);table.moveDestination=k;vpShowMoveCursor(table)}}return EvCancelAll(ev)}return true}function vpMBmouseUp(ev){var table=gViewTable;if(table.vpMode==kVPmodeMoveActive){var moveDst=table.moveDestination;var moveSrc=table.moveSource;vpMoveColFromTo(table,moveSrc,moveDst)}vpMoveModeExit();vpDisplaySaveBannerIfNeeded(table);return EvCancelAll(ev)}function vpMoveColFromTo(table,moveSrc,moveDst){if(!moveSrc||moveDst==null){return moveSrc}if(moveDst==moveSrc||moveDst==moveSrc-1){return moveSrc}var numCols=table.rows[0].cells.length;for(var n=0;n<table.rows.length;++n){var row=table.rows[n];if(!IsNormalRow(table,row)){continue}if(moveDst<numCols-1){row.insertBefore(row.cells[moveSrc],row.cells[moveDst+1])}else{row.appendChild(row.cells[moveSrc])}}if(moveDst>moveSrc){return moveDst}return moveDst+1}function vpInsertBlankColumn(table,colIndex,dbid,fid){var numCols=table.rows[0].cells.length;for(var n=table.rows.length-1;n>=0;--n){var row=table.rows[n];if(!IsNormalRow(table,row)){row.cells[0].colSpan=row.cells[0].colSpan+1;continue}var newcell=TableCellInsertAt(row,colIndex+1);if(newcell){if(n==0){newcell.qbFID=fid;var finfo=GetFinfo(fid,gViewDBID,gViewQID);SetInnerHTML(newcell,finfo.name)}else{SetInnerHTML(newcell,"retrieving...");newcell.style.color="#777777";newcell.style.fontStyle="italic"}}}return colIndex+1}function BuildURLroot(table,action,options){if(!table.qbDBID){table.qbDBID=GetHTMLattribute(table,"qbDBID");table.qbQID=GetHTMLattribute(table,"qbQID")}var url=table.qbDBID+"?a="+action+"&qid="+table.qbQID;var withATUparams=((options&kOpt_WithATUparams)!=0);if(withATUparams&&table.qbATUparams){url+=table.qbATUparams}return url}function BuildDeltaParam(table,op,opval){var deltaParam;if(table&&table.qbOrigDelta){deltaParam=table.qbOrigDelta}else{deltaParam=""}var deltaArray=deltaParam.split("~");UpdateDeltaArray(deltaArray,table,op,opval);var newDeltaParam="";for(var n=0;n<deltaArray.length;++n){if(deltaArray[n]!=""){newDeltaParam+=deltaArray[n]+"~"}}if(newDeltaParam!=""){newDeltaParam="&dlta="+urlencode(newDeltaParam)}return newDeltaParam}function UpdateDeltaArray(deltaArray,table,op,opval){if(op){CleanDeltaArray(deltaArray,op,opval);deltaArray.push(op+opval)}if(!table||table.rows.length==0){return}var newFIDlist=vpGenFidList(table);if(newFIDlist!=table.qbOrigFIDlist&&typeof table.qbOrigFIDlist!=="undefined"){CleanDeltaArray(deltaArray,kVPfidList);deltaArray.push(kVPfidList+newFIDlist)}var dynamicHash="#dynamic/";if(location.hash.indexOf(dynamicHash)==0){try{JSON.parse((location.hash.substr(dynamicHash.length)))}catch(e){}}var numcols=table.rows[0].cells.length;for(var n=0;n<numcols;++n){var cell=table.rows[0].cells[n];var cpfid=cell.qbFID;var newprops=cell.qbNewCprops;var oldprops=cell.qbCprops;if(newprops&&oldprops){ReplaceDeltaParamIf(deltaArray,kVPcolHeading,cpfid,newprops.heading,oldprops.heading);ReplaceDeltaParamIf(deltaArray,kVPcolJust,cpfid,newprops.just,oldprops.just)}}}function ReplaceDeltaParamIf(deltaArray,op,opval,newvalue,oldvalue){if(newvalue!=oldvalue){ReplaceDeltaParam(deltaArray,op,opval,newvalue)}}function ReplaceDeltaParam(deltaArray,op,opval,value){var prefix=op+opval+"_";for(var n=0;n<deltaArray.length;++n){if(StringStartsWith(deltaArray[n],prefix)){deltaArray.splice(n,1);--n}}deltaArray.push(prefix+value)}function CleanDeltaArray(deltaArray,op,opval){for(var n=0;n<deltaArray.length;++n){var deltaVal=deltaArray[n];var removeThisOne=false;if(op==kVPsortUp||op==kVPsortDown||op==kVPgroupUp||op==kVPgroupDown){var fid=opval;var sortUpParam=kVPsortUp+fid;var sortDnParam=kVPsortDown+fid;var groupUpParam=kVPgroupUp+fid;var groupDnParam=kVPgroupDown+fid;if(deltaVal==sortUpParam||deltaVal==sortDnParam||deltaVal==groupUpParam||deltaVal==groupDnParam){removeThisOne=true}}if(op==kVPsortMore){removeThisOne=(StringStartsWith(deltaVal,kVPsortUp)||StringStartsWith(deltaVal,kVPsortDown)||StringStartsWith(deltaVal,kVPgroupUp)||StringStartsWith(deltaVal,kVPgroupDown)||StringStartsWith(deltaVal,kVPsortMore))}if(op==kVPfidList){removeThisOne=StringStartsWith(deltaVal,op)}if(removeThisOne){deltaArray.splice(n,1);--n}}}function GetColumnIndex(table,cell){for(var n=0;n<table.rows[0].cells.length;++n){if(cell==table.rows[0].cells[n]){return n}}return -1}function vpCreateMoveBox(){if(!gViewTable.moveBox){var moveBox=document.createElement("DIV");moveBox.style.position="absolute";moveBox.style.display="none";moveBox.style.zIndex=300;moveBox.style.border="3px solid #FFCC00";moveBox.style.cursor="move";moveBox.style.backgroundColor="#fff7d6";moveBox.style.paddingTop="4px";moveBox.style.filter="alpha(opacity=60)";moveBox.style.opacity="0.60";moveBox.style.fontWeight="bold";moveBox.onmousedown=vpMBmouseDown;moveBox.onmousemove=vpMBmouseMove;moveBox.onmouseup=vpMBmouseUp;moveBox.style.textAlign="center";document.body.appendChild(moveBox);gViewTable.moveBox=moveBox;moveBox.qbTable=gViewTable}}function vpCreateResizeBox(){if(!gViewTable.resizeBox){var resizeBox=document.createElement("DIV");resizeBox.style.position="absolute";resizeBox.style.display="none";resizeBox.style.zIndex=20;resizeBox.style.border="3px solid red";resizeBox.style.cursor=(IsIE()?"col-resize":"E-resize");resizeBox.style.backgroundColor="red";resizeBox.style.paddingTop="4px";resizeBox.onmousedown=vpRZmouseDown;document.body.appendChild(resizeBox);gViewTable.resizeBox=resizeBox;resizeBox.qbTable=gViewTable;gViewTable.onmousemove=vpRZmouseMove;gViewTable.onmouseup=vpRZmouseUp}}function vpMoveModeEnter(){vpDelite();document.body.style.MozUserSelect="none";gViewTable.vpMode=kVPmodeMovePending;gViewTable.moveSource=gViewColIndex;vpCreateMoveBox();var ebox=GetBox(gViewCell);var height=ebox.bottom-ebox.top;var moveBox=gViewTable.moveBox;moveBox.style.left=(ebox.left-3)+"px";moveBox.style.top=(ebox.top-3)+"px";moveBox.style.width=(ebox.right-ebox.left)+"px";moveBox.style.height=(height-5)+"px";SetInnerHTML(moveBox,vpGetHeadcellText(gViewCell));moveBox.style.display="";if(!gViewTable.csides){gViewTable.csides=new Array()}gViewTable.csides.length=0;for(var n=0;n<gViewTable.rows[0].cells.length;++n){gViewTable.csides.push(GetElemRight(gViewTable.rows[0].cells[n]))}}function vpMoveModeExit(){if(gViewTable&&gViewTable.vpMode&&gViewTable.vpMode!=kVPmodeNormal){if(gViewTable.moveBox){gViewTable.moveBox.style.display="none"}if(gViewTable.resizeBox){gViewTable.resizeBox.style.display="none"}document.body.style.MozUserSelect="";vpHideMoveCursor();gViewTable.vpMode=kVPmodeNormal;if(gMdownHeadCell){gMdownHeadCell.downX=null;gMdownHeadCell=null}}}function vpShowMoveCursor(table){var moveDst=table.moveDestination;var moveSrc=table.moveSource;var color="#00ee00";if(moveDst==moveSrc||moveDst==moveSrc-1){color="#FFCC00"}var cell=table.rows[0].cells[moveDst];if(gVPmoveCursor==null){gVPmoveCursor=document.createElement("DIV");gVPmoveCursor.style.position="absolute";gVPmoveCursor.style.display="none";gVPmoveCursor.style.zIndex=300;document.body.appendChild(gVPmoveCursor)}var ebox=GetBox(cell);gVPmoveCursor.style.left=(ebox.right-1)+"px";gVPmoveCursor.style.top=(ebox.top)+"px";gVPmoveCursor.style.width="3px";gVPmoveCursor.style.height=Math.min(GetElemHeight(table)-2,1600)+"px";gVPmoveCursor.style.backgroundColor=color;gVPmoveCursor.style.display=""}function vpHideMoveCursor(){if(gVPmoveCursor){gVPmoveCursor.style.display="none"}}function vpResizeModeEnter(){HideMenus();document.body.style.MozUserSelect="none";gViewTable.vpMode=kVPmodeResizePending;gViewTable.resizeCol=gViewColIndex;gViewTable.origColWidth=gViewCell.offsetWidth;vpCreateResizeBox();var ebox=GetBox(gViewCell);var height=ebox.bottom-ebox.top;var resizeBox=gViewTable.resizeBox;resizeBox.style.left=(ebox.right-5)+"px";resizeBox.style.top=(ebox.top-3)+"px";resizeBox.style.width="0px";resizeBox.style.height=(height)+"px";resizeBox.style.display=""}var gViewopsWindow;var gPrintRecordsWindow;var ggg=0;function onMoverViewMiniBar(dbid,qid){if(TopPopupDiv()!=null){return}gViewDBID=dbid;gViewQID=qid;gViewTable=getElementBy("VR_"+dbid+"_"+qid);ConfigureTableMenus(gViewTable)}function ConfigureTableMenus(table){var IsMini=table&&table.qbIsMini;var canExport=table&&table.qbCanExp;var showMRops=table&&table.qbMRops&&!table.IsNewSummary;var clrFlags=table&&table.qbClrFlags&&!table.IsNewSummary;var hasCalen=table&&table.qbHasCalen;var hasTimln=table&&table.qbHasTimln;var subscrOpt=(table?table.qbSubscr:"");var canAdmin=table&&table.qbCanAdmin;var canPrint=table&&table.qbCanPrint;var canEmail=table&&table.qbCanEmail;var isCalen=table&&table.IsCalendar;var isTimln=table&&table.IsTimeline;openCloseElem("vexpss",canExport);openCloseElem("vimpexp",canExport&&showMRops);openCloseElem("vexptb",canExport&&table.qbCanExpToTab);openCloseElem("vexphr",canExport);openCloseElem("vsandr",showMRops&&table.qbSomeMod);openCloseElem("vsubscr",!IsMini&&canEmail&&subscrOpt!="");openCloseElem("vcflags",clrFlags);openCloseElem("vprint",canPrint);openCloseElem("vprintSep",canPrint);openCloseElem("dCalTim",hasCalen||hasTimln);openCloseElem("vscalen",hasCalen&&!isCalen);openCloseElem("vstimln",hasTimln&&!isTimln);var isTableView=table&&table.IsTableView&&!table.IsTableWithSummaryOnly;openCloseElem("vsmore",isTableView);openCloseElem("vdefcol",!IsMini&&canAdmin&&isTableView);openCloseElem("vother",!IsMini&&showMRops&&(isTableView||isTimln));openCloseElem("vchangeowner",gReqUserIsDBAdmin);openCloseElem("vdelete",table.qbCanDel);openCloseElem("EmailInvitation",gUserCanShare)}function OnClickPage(pagenum){var recsPerPage=gViewTable.qbRecsPerPage;var skipcount=recsPerPage*pagenum;for(var n=0;n<gVPviews.length;++n){if(gVPviews[n]==gViewTable){gVPviews.splice(n,1);break}}vpUpdateSection(gViewTable,BuildDeltaParam(gViewTable),BuildEmbParams(gViewTable,skipcount,recsPerPage))}function vpUpdateSection(table,deltaParam,embParams){var isViewTable=(table.id==gViewTable.id);if(IsStandaloneView()){var url=BuildURLroot(table,"q",kOpt_WithATUparams)+embParams+deltaParam;location=url;return}HideMenus();var charset=document.characterSet?document.characterSet:document.charset;var url=BuildURLroot(table,"QBI_GenView",kOpt_WithATUparams)+embParams+deltaParam+"&encoding=utf-8&charset="+charset;if(table&&table.qbRIDlistID){url+="&rl="+ob32encode(table.qbRIDlistID)}if(IsNewDashboardView()){url+="&noStyleNoScript=1"}var jax=new jaxreq(url);if(window.gIsAppDashboard){jax.viewContainer=$(table).closest(".Contents")[0]}else{if(IsNewDashboardView()){jax.viewContainer=$(table).closest(".EmbeddedReportContainer")[0]}else{jax.viewContainer=QBselectParentNode(table,"td[1]")}}jax.viewTableID=table.id;jax.DoSyncCmd();SetInnerHTML(jax.viewContainer,jax.AssembleChunks("vwtxt"));$("table.TableReportDisplay").removeClass("DisplayNone");vpInitTable(jax.viewTableID);if(IsTableDashboardView()&&StringContains(jax.url,"qskip")){$(document).scrollTop(0)}if(isViewTable){if(table.QBautoResizeObj){RemoveAutoResizeObj(table.QBautoResizeObj)}gViewTable=getElementBy(jax.viewTableID);AddResizeViewElement(gViewTable)}if(!_.isUndefined(window.initMultiUserToolTips)){initMultiUserToolTips()}if(typeof(SetupRowViewEvents)=="function"){SetupRowViewEvents()}if(!IsStandaloneView()&&!IsTableDashboardView()&&!IsNewDashboardView()){$("#mainCell td.EmbeddedReport").show()}}function BuildEmbParams(table,newSkipCount,newRecsPerPage){var param="";if(typeof newSkipCount!="undefined"){param+="&qskip="+newSkipCount}else{if(table.qbSkipCount&&table.qbSkipCount>0){param+="&qskip="+table.qbSkipCount}}if(typeof newRecsPerPage!="undefined"){if(newRecsPerPage!=-1){param+="&qrppg="+newRecsPerPage}}else{if(table.qbRecsPerPage&&table.qbRecsPerPage>0){param+="&qrppg="+table.qbRecsPerPage}}if(table.qbTBtext!=""&&table.qbTBtext!=null){param+="&qtbtx="+(table.qbTBtext||"")}if(table.qbMaxHeight&&table.qbMaxHeight>0){param+="&qmaxh="+table.qbMaxHeight}return param}function OnChangeGotoPage(elem){var pagenum=Number(GetValue(elem))-1;OnClickPage(pagenum)}function SetupTableGlobals(elem){if(TopPopupDiv()!=null){return false}var table=null;if(IsStandaloneView()||IsTableDashboardView()){table=$("table.searchResults").get(0)}else{table=QBselectParentNode(elem,"table")}if(!table){return}var newDBID=GetHTMLattribute(table,"qbDBID");var newQID=GetHTMLattribute(table,"qbQID");if(gViewDBID!=newDBID||gViewQID!=newQID){HideMenus()}gViewDBID=newDBID;gViewQID=newQID;gViewTable=getElementBy("VR_"+gViewDBID+"_"+gViewQID);return true}function OnClickGE(elem){QB.Storage.UserApp.set("gridEditEntryPage",window.location.href)}function OnMoverGE(elem){if(!SetupTableGlobals(elem)){return}var url=BuildURLroot(gViewTable,"q",kOpt_WithATUparams)+BuildDeltaParam(gViewTable,kVPmode,"g");var emb=BuildEmbParams(gViewTable,gViewTable.qbSkipCount,-1);url+=emb;if(gViewTable.qbGExtra){url+=gViewTable.qbGExtra}url+="&navBack=true";elem.href=url}function OnMoverEditView(elem){if(!SetupTableGlobals(elem)){return}var url=BuildURLroot(gViewTable,"viewbuild")+BuildDeltaParam(gViewTable);elem.href=url}function CustThisReportProc(){gViewTable=getElementBy("VR_"+gViewDBID+"_"+gViewQID);if(gViewTable!==null){var url=BuildURLroot(gViewTable,"viewbuild")+BuildDeltaParam(gViewTable)}else{var url="?a=viewbuild&qid="+gViewQID}SetLocation(url)}$(function(){$("#stdCustThisReportButton, #changedCustomizeButton").not(".GridEditAction").click(function(){var qidToSave=getQIDForSave();var qParams=+qidToSave+(gVPviews[0]?BuildDeltaParam(gVPviews[0]):"");SetLocation("?a=viewbuild&qid="+qParams);return false});$("#stdCustThisReportButton, #changedCustomizeButton").not(".GridEditAction").attr("href","#")});function getQIDForSave(){var qidToSave;if(typeof kSSRqid!=="undefined"){qidToSave=kSSRqid}if(typeof gDynamicTempQID!=="undefined"&&gDynamicTempQID!=-1&&gDynamicTempQID!=null&&gDynamicTempQID!=0){qidToSave=gDynamicTempQID}return qidToSave}function OnMoverOther(elem){if(!SetupTableGlobals(elem)){return}ConfigureTableMenus(gViewTable)}function OnClickSandR(){HideMenus();var url=gViewDBID+"?a=genSandR&ridlistid="+gViewTable.qbRIDlistID;gViewopsWindow=window.open(url,"viewops","width=400,height=400,resizable");if(gViewopsWindow){gViewopsWindow.focus()}return false}function OnClickClearFlags(){HideMenus();QB.Dialog.confirm({title:"Clear Flags",size:430,contents:'This will clear the "New" and "Updated" flags for the entire <b>'+gTableInfo[gViewDBID].name+"</b> table.",contentType:"html",id:"qbDialogClearFlags",focusedButton:null,confirm:{focused:false,click:function(){ViewClearFlagsReally();$(this).dialog("close")}},cancel:{focused:false,click:function(){$(this).dialog("close")}}});return false}function ShowAsCalendar(){HideMenus();var url=BuildURLroot(gViewTable,"q",kOpt_WithATUparams)+BuildDeltaParam(gViewTable,kVPmode,"c");location=url}function ShowAsTimeline(){HideMenus();var url=BuildURLroot(gViewTable,"q",kOpt_WithATUparams)+BuildDeltaParam(gViewTable,kVPmode,"t");location=url}function ViewClearFlagsReally(){var jax=new jaxreq(gViewDBID+"?a=QBI_ClearFlags");jax.viewTable=gViewTable;jax.DoAsyncCmd(ViewClearFlagsCB);return false}function ViewClearFlagsCB(jax){var qbnode=jax.GetXML();if(qbnode&&jax.errcode==0){var table=jax.viewTable;$(table).find('img[src*="new"]').hide();$(table).find('img[src*="updated"]').hide();$.jGrowl("Flags cleared",{theme:"jGrowl-green",pool:1,life:2000})}}function IsFlagIcon(icon){if(icon==null){return false}return(StringContains(icon.src,"updated.gif")||StringContains(icon.src,"new.gif"))}function ShowCantSubscribe(){QBalert("You can't subscribe to this report now that you've made changes to it.")}function OnMoverSubscribe(elem){if(gReqUserDelayVerify){url="javascript:void(showVerificationRequiredDialog('SubscribeToReport'))"}else{if(BuildDeltaParam(gViewTable)==""){var url=gViewTable.qbSubscr}else{url="javascript:void(ShowCantSubscribe())"}}elem.href=url}function openSubscription(elem){var url=BuildURLroot(gViewTable,"GenPeriodicReportEdit","");elem.href=url}var emailQueryInputSettings=$.extend({},tokenInputSettings,{allowDomains:false});emailQueryInputSettings.classes=$.extend({},tokenInputSettings.classes,{dropdown:"token-input-dropdown-facebook token-input-dropdown-facebook-wide"});var addressBookClickedEQ;var addressBookEQ;function OnMoverCustomizeView(elem){SetupTableGlobals(elem)}function OnMoverEmailView(elem){SetupTableGlobals(elem)}function OnClickEmailView(elem){HideMenus();if(gReqUserDelayVerify){showVerificationRequiredDialog("EmailReport");return}GetAddressBookBody();var url=BuildURLroot(gViewTable,"QBI_GetEmailViewInfo",kOpt_WithATUparams)+BuildDeltaParam(gViewTable);var jax=new jaxreq(url);jax.DoSyncCmd();if(jax.success){$("#emailQuerySubj").val(jax.GetValue("subject"));$("#emailQueryMsg").html(HTMLEncode(jax.GetValue("msg")));$("#emailQueryError").hide();var currentEmailDialog=$("#emailQueryDialog").clone();$(".emailAddressInput",currentEmailDialog).tokenInput("",emailQueryInputSettings);$.TokenList.tokenCounter("reset");QB.Dialog.confirm({title:"Email "+HTMLEncode(jax.GetValue("queryName")),type:"Info",contents:currentEmailDialog,contentType:"selector",size:600,id:"currentEmailQueryDialog",confirm:{text:"Send",type:"Success",click:function(){if(doEmailView(false,currentEmailDialog)){$(this).dialog("close")}}},cancel:{text:"Cancel"}});if(contacts.length>0){$("#emailQueryInputLabel").text(inputLabelHasContacts)}else{if(!knowThatContactsIsEmpty){contactsInterval=setInterval("checkContactsAndSetLabel()",500)}}$("#emailQueryAddressBookButton",currentEmailDialog).click(function(event){addressBookClickedEQ=this;if(addressBookEQ===undefined){var abOpts={selectedUsersEventHandler:addFromAddressBook,cancelledEventHandler:focusOnInput,gABAllowEveryoneGID:false,gABNoDomGroups:true};addressBookEQ=new AddressBook(abOpts)}addressBookEQ.open(addressBookClickedEQ)});$.TokenList.tokenCounter("reset")}else{alert(jax.errdetails)}}function doEmailView(manyUsersConf,context){var toList="";var emailInput=$(".emailAddressInput",context).val().split(",");for(i=0;i<emailInput.length;i++){if(emailInput[i]!=""){if(toList==""){toList+=emailInput[i]}else{toList+=kDelimA+emailInput[i]}}}if(toList==""){showEmailError("You did not enter a destination email address.");return false}if($(".invalid-token").size()>0){showEmailError("Please correct the invalid users, groups, or email addresses.");return false}var url=BuildURLroot(gViewTable,"QBI_ValidateEmailView",kOpt_WithATUparams)+BuildDeltaParam(gViewTable);var jax=new jaxreq(url);jax.AddValue("toList",toList);jax.AddValue("subject",$("#emailQuerySubj",context).val());jax.AddValue("msg",$("#emailQueryMsg",context).val());jax.AddValue("confManyUsers",manyUsersConf);jax.AddValue("rl",ob32encode(gViewTable.qbRIDlistID));jax.AddValue("CompareWithAppLocalTime","true");jax.DoSyncCmd();if(jax.success){if(jax.GetValue("needsConfirmation")=="true"){QB.Dialog.confirm({title:"Warning",type:"Info",contents:"<div><p class='confirmMessage'>"+jax.GetValue("confirmationDetails")+"</p></div>",contentType:"HTML",size:600,id:"currentEmailQueryDialog",confirm:{text:"Send",type:"Success",click:function(){doEmailView(true,context);$(this).dialog("close")}},cancel:{text:"Cancel"}});return true}notifyGreen(jax.GetValue("confmsg"));return true}else{showEmailError(jax.GetValue("errdetail"));return false}}function showEmailError(text){var errorElt=$("#currentEmailQueryDialog").find("#emailQueryError");errorElt.html(HTMLEncode(text)).show()}function doManyUsersEmailConf(text){}function OnMoverDefOrder(elem){var url=gViewDBID+"?a=defaultreportsettings";elem.href=url}function OnClickChangeOwner(){HideMenus();var url=BuildURLroot(gViewTable,"GenChngRecOwner",kOpt_WithATUparams)+BuildDeltaParam(gViewTable)+"&ridlistid="+gViewTable.qbRIDlistID;gViewopsWindow=window.open(url,"changeowner","width=400,height=300,resizable");if(gViewopsWindow){gViewopsWindow.focus()}return false}function OnClickDelete(){HideMenus();var url=BuildURLroot(gViewTable,"GenMultiDelete",kOpt_WithATUparams)+BuildDeltaParam(gViewTable)+"&ridlistid="+gViewTable.qbRIDlistID;gViewopsWindow=window.open(url,"delete","width=400,height=300,resizable");if(gViewopsWindow){gViewopsWindow.focus()}return false}function OnClickExpandedURL(){HideMenus();var sUrl=BuildURLroot(gViewTable,"JBI_GenExpandedURL",kOpt_WithATUparams)+BuildDeltaParam(gViewTable)+"&ridlistid="+gViewTable.qbRIDlistID;var requestdata={};$.ajax({url:"/db/"+sUrl,type:"POST",async:false,dataType:"json",data:requestdata,success:function(data,status,resp){if(data.errorCode=="0"){var outputstring="<br>The expanded URL for this form is:<br><br>?a=q"+data.expURL+"<br><br><i>(This is only of interest to the most technical of users)<br><br>";QB.Dialog.alert({title:"Expanded URL",size:600,contents:outputstring,contentType:"html",id:"qbExpandedURL",focusedButton:null,confirm:{text:"OK",focused:false,click:function(){$(this).dialog("close")}}})}else{$.jGrowl(data.errorMsg,{theme:"jGrowl-red",pool:1,life:4000})}}});return false}function OnMoverFullView(elem){if(!SetupTableGlobals(elem)){return}var url=BuildURLroot(gViewTable,"q",kOpt_WithATUparams)+BuildDeltaParam(gViewTable);elem.href=url}function OnClickPrintView(elem){HideMenus();vpInitTable(gViewTable);if(gViewTable.IsTimeline){QB.Dialog.confirm({title:"Print Options",size:500,contents:$("#TimelinePrintSelector"),contentType:"selector",id:"qbDialogPrintTimeline",focusedButton:null,confirm:{text:"OK",focused:false,click:function(){DoPrintTimeline();$(this).dialog("close")}},cancel:{focused:false,click:function(){$(this).dialog("close")}}});return false}if(!gViewTable.IsTableView||gViewTable.IsTableWithSummaryOnly){var url=BuildURLroot(gViewTable,"q",kOpt_WithATUparams)+BuildDeltaParam(gViewTable,kVPprint,"");gPrintRecordsWindow=window.open(url,"PrintFriendly","width=950,height=750,resizable,scrollbars,menubar");return}SetInnerHTML("printNumRecs",gViewTable.qbRecsMatch);var menu=getElementBy("FormChooser");menu.options.length=0;var forminfo=gTableInfo[gViewDBID].forminfo;for(var n=0;n<forminfo.length;++n){AppendMenuOption(menu,forminfo[n].name,forminfo[n].dfid)}SetValue(menu,gViewTable.qbDefDFID);if(IsChecked("printview")){onPrintViewClicked()}QB.Dialog.confirm({title:"Print Options",size:400,contents:$("#PrintSelector"),contentType:"selector",id:"qbDialogPrint",focusedButton:null,confirm:{text:"OK",focused:false,click:function(){DoPrint();$(this).dialog("close")}},cancel:{focused:false,click:function(){$(this).dialog("close")}}});return false}function DoPrintTimeline(){var params="&pt="+(IsChecked("printSinglePage")?"s":"m");if(IsChecked("printMultiplePages")){params+="&tlStart="+gViewTable.qbTimelineStart+"&tlEnd="+gViewTable.qbTimelineEnd}var url=BuildURLroot(gViewTable,"q",kOpt_WithATUparams)+BuildDeltaParam(gViewTable,kVPprint,"")+params;gPrintRecordsWindow=window.open(url,"PrintFriendly","width=950,height=750,resizable,scrollbars,menubar");if(gPrintRecordsWindow){gPrintRecordsWindow.focus()}}function DoPrint(){var table=gViewTable;if(IsChecked("printview")){var url=BuildURLroot(gViewTable,"q",kOpt_WithATUparams)+BuildDeltaParam(table,kVPprint,"");gPrintRecordsWindow=window.open(url,"PrintFriendly","width=950,height=750,resizable,scrollbars,menubar")}else{var url=gViewDBID+"?a=printrecords&ridlist="+table.qbRIDlistID+"&start="+table.qbSkipCount+"&num="+table.qbRecsShown+"&dfid="+GetValue("FormChooser");gPrintRecordsWindow=window.open(url,"PrintRecords","width=850,height=750,resizable,scrollbars,menubar")}if(gPrintRecordsWindow){gPrintRecordsWindow.focus()}}function onPrintRecordsClicked(){if(gViewTable.qbRecsShown>kMaxSingleRecsToPrint){alert("LIMIT EXCEEDED\n\nAlthough "+gViewTable.qbRecsShown+" records are displayed in this report, only the first "+kMaxSingleRecsToPrint+" will be printed.\n        Modify the report to display no more than "+kMaxSingleRecsToPrint+" records if you want to print them all.")}openAndShowElem("PrintOnePerPageOptions")}function onPrintViewClicked(){closeAndHideElem("PrintOnePerPageOptions")}function OnMoverExportToSS(elem){var url=BuildURLroot(gViewTable,"q",kOpt_WithATUparams)+BuildDeltaParam(gViewTable,kVPexportSS,"");elem.href=url}var gXttURL;function OnClickExportToTable(){HideMenus();gXttURL="&qid="+gViewQID+gViewTable.qbATUparams+BuildDeltaParam(gViewTable);var accountID=gViewTable.qbAccountID;var expWindow=window.open("main?a=AppPicker&param0=AppPicker&accountid="+accountID,"appPicker","width=400,height=400,resizable");expWindow.focus();return false}function PickerCallback(itemID,itemName,itemOther,param0,param1,param2){if(param0=="TablePicker"||(param0=="AppPicker"&&itemOther=="Single")){var url=gViewDBID+"?a=ExportToTable&DestDB="+itemID+gXttURL;location=url}else{if(param0=="AppPicker"){var dbid=itemID;var expWindow=window.open("main?a=TablePicker&dbid="+dbid+"&param0=TablePicker","tablePicker","width=400,height=400,resizable");expWindow.focus()}else{alert("Error choosing application. Please try again.")}}}function DoRevertView(){if(gReqTemplName=="tabledashboard"){location=gReqDBID+"?a=td"}else{if(kSSRderivedQID==-1){location=gReqDBID+"?a=q&qid="+kSSRqid}else{location=gReqDBID+"?a=q&qid="+kSSRderivedQID}}}function OpenCloseSaveBanner(doOpen){doOpen=doOpen||gViewIsNew||gViewIsModified;doOpen=doOpen&&gUserCanView;if(gSaveBanner){if(doOpen&&!gSaveBannerInited){var canSave=true;if(gViewQID==-5){canSave=false}if(gTableHomeIsDefaultCantSave){canSave=false}if(gViewIsShared&&!gViewSvShared){canSave=false}if(gViewTable){if(gViewTable.qbIsShared&&!gViewTable.qbSvShared){canSave=false}if(gViewTable.qbIsFrgnPV){canSave=false}}$("#pageNavBarHeader").append($("#saveAsReport"));var changedSaveSplitButton=$("#changedSaveSplitButton");if(canSave){changedSaveSplitButton.splitbutton({saveSelection:false,alternateActionsMenu:"#changedSaveMenu",menuButtonClass:"Vibrant Success",title:"Other Save options"});$("#changedSaveSplitButton").click(function(){overwriteReport()});$("#changedSaveMenuItem").click(function(){overwriteReport()})}else{$("#changedSaveSplitButton").click(function(){showSaveAsReportDialog(gViewIsNew)})}$("#changedSaveAsMenuItem").click(function(){showSaveAsReportDialog(gViewIsNew)});$("#changedCancelButton").click(function(){DoRevertView()});gSaveBannerInited=true}}if(gSaveBannerInited){$(gSaveBanner).toggle(doOpen);$("#divider2").toggle(doOpen);$("#favoriteThisAction").trigger(doOpen?"favoriting-disable":"favoriting-enable");if(doOpen){$(".TablebarFooterTriangle").hide();$("#pageNavBar").addClass("ReportChangeModActive")}else{$(".TablebarFooterTriangle").show();$("#pageNavBar").removeClass("ReportChangeModActive")}if($(gSaveBanner).is(":visible")){$("#stdCustThisReportButton").hide();$("#czThisBut").hide()}else{$("#stdCustThisReportButton").show();$("#czThisBut").show()}}else{$("#stdCustThisReportButton").show();$("#czThisBut").show();$("#favoriteThisAction").show()}}var gBodyPrevWidth=-1;function ViewCommonUnloadProc(){if(gViewopsWindow){gViewopsWindow.close()}if(gPrintRecordsWindow){gPrintRecordsWindow.close()}}function ViewCommonLoadProcDefer(){if(!doneSetupReportContainers){$("table.TableReportDisplay").removeClass("DisplayNone");doneSetupReportContainers=true}$(document.body).on("click","td.SortableField",ClickedSortCol);gSaveBanner=getElementBy("saveAsReport");var doOpen=gUserCanView&&(gViewIsNew||gViewIsModified);var numViews=gVPviews.length;for(var n=0;n<numViews;++n){var table=gVPviews[n];AddResizeViewElement(table)}gViewTable=getElementBy("VR_"+gViewDBID+"_"+gViewQID);vpInitTable(gViewTable);OpenCloseSaveBanner(doOpen);$("#F2ThelpLink").click(function(){QB.Dialog.confirm({size:650,contents:$("#F2Thelpdiv"),contentType:"selector",id:"F2Thelp",focusedButton:null,confirm:{text:"OK"},cancel:null})});maybeInitStickyReportHeaders()}function maybeInitStickyReportHeaders(){var ifv=!!GetURLParameterValue(document.location,"ifv");if(!ifv&&(IsStandaloneView()||IsTableDashboardView())){stickHeaderWhileScrolling();return true}return false}function stickHeaderWhileScrolling(){var elements=$(".searchResults .hd.Frozen");if(elements.length==0){return}var predecessor=$("#pageNavBar");var frozenElement=elements.get(0);frozenElement=$(frozenElement).css("z-index",200);var table=frozenElement.closest("table.searchResults");sticker=frozenElement.clone().css({visibility:"hidden"});frozenElement.after(sticker);var frozenElemHeight=frozenElement.outerHeight();var predecessorBottom=predecessor.css("top");var frozenElemLeft=frozenElement.offset().left;table.bind("resize.reportstickyheaders",_.throttle(adjustLeft,50));$(window).off(".reportstickyheaders");$(window).on("scroll.reportstickyheaders",_.throttle(adjustStuckElement,50));$(window).on("resize.reportstickyheaders",_.throttle(adjustElementWidths,150));$(window).on("updateStickyHeaders.reportstickyheaders",updateStickyHeaders);adjustStuckElement();function adjustStuckElement(){var isStuck=frozenElement.hasClass("StickyHeader");var predecessorBottomOffset=predecessor.offset().top+predecessor.outerHeight();var shouldStick=((isStuck?sticker:frozenElement).offset().top<=predecessorBottomOffset);shouldStick=shouldStick&&(table.offset().top+table.outerHeight()-predecessorBottomOffset>=frozenElemHeight);if(shouldStick){frozenElement.css("left",(frozenElemLeft-$(window).scrollLeft())+"px")}if(shouldStick&&!isStuck){var elementHeight=(isStuck?sticker:frozenElement).outerHeight();sticker.css("height",elementHeight+"px").show();frozenElement.width(sticker.width());frozenElement.find("td").each(function(){var t=$(this);t.width(t.outerWidth())});frozenElement.addClass("StickyHeader");predecessorBottom=predecessor.css("top");var matches=predecessorBottom.match(/(\d+)/);predecessorBottom=(matches&&matches.length)?matches[0]:0;predecessorBottom=predecessor.outerHeight()+parseInt(predecessorBottom);frozenElement.css({top:predecessorBottom+"px"})}else{if(!shouldStick){sticker.css("height","1px").hide();frozenElement.removeClass("StickyHeader").css("top","")}}}function adjustElementWidths(){var isStuck=frozenElement.hasClass("StickyHeader");if(isStuck){var refRow=table.children("tbody").children(".od, .ev").first();if(refRow.length>0){var nextRowTds=refRow.find("td");var col=0;frozenElement.width(refRow.width());frozenElement.find("td").each(function(){var t=$(this);t.width($(nextRowTds[col]).outerWidth());++col})}var predecessorBottomNew=predecessor.css("top");var matches=predecessorBottomNew.match(/(\d+)/);predecessorBottomNew=(matches&&matches.length)?matches[0]:0;predecessorBottomNew=predecessor.outerHeight()+parseInt(predecessorBottomNew);if(predecessorBottomNew!=predecessorBottom){frozenElement.css({top:predecessorBottomNew+"px"});predecessorBottom=predecessorBottomNew}}}function updateStickyHeaders(){sticker.remove();sticker=frozenElement.clone().css({visibility:"hidden"}).removeClass("StickyHeader");var isStuck=frozenElement.hasClass("StickyHeader");frozenElement.after(sticker);if(!isStuck){sticker.css("height","1px").hide()}adjustElementWidths()}function adjustLeft(){var isStuck=frozenElement.hasClass("StickyHeader");var offsetLeft=(isStuck?sticker:frozenElement).offset().left;if(frozenElemLeft!=offsetLeft){frozenElemLeft=offsetLeft;frozenElement.css("left",(frozenElemLeft-$(window).scrollLeft())+"px")}}}var gCollapsedResizeElements=[];function AddResizeViewElement(table){var odiv=QBselectParentNode(table,"div");if(IsClass(odiv,"VRinDiv")){var outerTable=QBselectParentNode(odiv,"table");if(outerTable&&(outerTable.style.width=="100%"||Number(table.qbMaxHeight)>0)){if(table.qbRightOff){var yoff=Number(table.qbRightOff)+19}else{yoff=34}if(!IsIE()){yoff+=4}var resizeObj=AddResizeElement(odiv,null,100,yoff,300);gGlobal=resizeObj;resizeObj.innerContent=table;resizeObj.limitToContentHeight=true;resizeObj.doMonitorContentWidth=true;if($(odiv).closest(".sectionDiv.collapsed").length>0){gCollapsedResizeElements.push(resizeObj)}if(odiv.style.height){resizeObj.maxHei=(table.qbMaxHeight?table.qbMaxHeight:GetStyleHeight(odiv))}table.QBautoResizeObj=resizeObj;resizeObj.rightOffset=null;DoAutoResizeElement(resizeObj)}}}function ViewCommonLoadProc(){gViewDBID=gReqDBID;gViewQID=gReqQID;if(!IsStandaloneView()&&!IsTableDashboardView()&&!IsNewDashboardView()){$(".EmbeddedReport").show()}setTimeout("ViewCommonLoadProcDefer()",100);$("#vsubscr").click(function(){SetCookie("QB_REFERER",location.href);return true})}var gViewCommonTasksAdded;if(!gViewCommonTasksAdded){AddLoadProcTask("ViewCommonLoadProc()");AddUnloadProcTask("ViewCommonUnloadProc()");gViewCommonTasksAdded=true}showjQueryPopup=function(elem){$(elem).dialog("open")};hidejQueryPopup=function(elem){$(elem).dialog("close")};function OpenEmailMenu(){$("#EmailMenu").show()}function OnClickEmailInvite(){HideMenus();openAddUserAutocomplete();return}function SetupRowViewEvents(el){$(el||document.body).off(".reportClickRecordRow").on("mousedown.reportClickRecordRow",'.searchResults tr[canView="true"]',function(evt){var newWindow=evt.ctrlKey;var mouseMoves=2;if(evt.target.tagName=="A"||evt.target.tagName=="SPAN"){return}var _curTarget=$(evt.currentTarget);_curTarget.off(".SetupRowViewEvents").on("mousemove.SetupRowViewEvents",function(evt){--mouseMoves});_curTarget.on("mouseup.SetupRowViewEvents",function(evt){_curTarget.off(".SetupRowViewEvents");if(mouseMoves<=0||evt.which!=1){return}var dbid=$(this).closest("table").attr("qbdbid");var newURL="/db/"+dbid+"?a=dr&rid="+$(this).attr("id").split("rid")[1]+$(this).attr("extra");if(newWindow){window.open(newURL,"_blank")}else{window.location=newURL}})})}function mapAddress(addressText,mapDiv){require(["geolocation"],function(geo){geo.mapAddress(addressText,mapDiv)})};